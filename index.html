<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warung Preisrechner</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0b1220; color:#e5e7eb; }
    header { padding:14px 16px; background:#111827; border-bottom:1px solid #1f2937; }
    h1 { margin:0; font-size:16px; }
    .muted { color:#94a3b8; font-size:12px; }
    .tabs { display:flex; gap:8px; padding:10px 16px; border-bottom:1px solid #1f2937; overflow:auto; }
    .tab { padding:8px 12px; border-radius:999px; border:1px solid #1f2937; background:#0f172a; color:#e5e7eb; cursor:pointer; }
    .tab.active { background:#2563eb; border-color:#2563eb; }
    main { padding:16px 16px 90px; max-width:820px; margin:auto; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:12px; margin-bottom:12px; }
    .row { display:grid; grid-template-columns:1fr 200px; gap:10px; align-items:center; margin:8px 0; }
    label { font-size:13px; color:#cbd5e1; }
    input, select, button {
      width:100%; padding:10px; border-radius:10px;
      border:1px solid #334155; background:#0b1220; color:#e5e7eb;
      font-size:14px;
    }
    button { background:#1f2937; cursor:pointer; }
    button.primary { background:#2563eb; border-color:#2563eb; }
    .kpi { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .kpi .box { background:#0b1220; border:1px solid #1f2937; padding:10px; border-radius:12px; }
    .big { font-size:18px; font-weight:700; }
    .footer { position:fixed; bottom:0; left:0; right:0; background:#111827; border-top:1px solid #1f2937; padding:10px 16px; display:flex; gap:10px; }
    .footer button { flex:1; }
    .hr { height:1px; background:#1f2937; margin:12px 0; }
  </style>
</head>

<body>
<header>
  <h1>Warung Preisrechner</h1>
  <div class="muted">Excel-Modell · manuelle Produkttyp-Auswahl · offlinefähig</div>
</header>

<div class="tabs" id="tabs"></div>
<main id="view"></main>

<div class="footer">
  <button id="exportBtn">JSON Export</button>
  <button id="importBtn">JSON Import</button>
  <button class="primary" id="saveBtn">Speichern</button>
</div>

<script>
(() => {
  const KEY = "warung_pricing_v1";

  const DEFAULT = {
    asumsi: {
      penjualan_unit_bulan: 2500,
      faktor_dus: 0.35,
      biaya_tetap_galon: 900,
      biaya_variabel_minuman: 100,
      susut_minuman: 2,
      susut_dus: 1,
      susut_buah: 15,
      cuci_galon: 300,
      antar_galon: 2000,
      round_idr: 500
    },
    fixed: {
      sewa: 1500000,
      tenaga: 1500000,
      listrik: 300000,
      internet: 150000,
      transport: 400000,
      lain: 150000
    }
  };

  let state = load();
  let tab = "fix";

  const TABS = [
    {id:"fix", label:"1) Fixkosten"},
    {id:"asumsi", label:"2) Asumsi"},
    {id:"calc", label:"3) Rechner"}
  ];

  function load() {
    try { return Object.assign({}, DEFAULT, JSON.parse(localStorage.getItem(KEY))); }
    catch { return structuredClone(DEFAULT); }
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify(state));
    alert("Gespeichert");
  }

  function num(v){ return Number(String(v).replace(/[^\d.]/g,""))||0; }
  function idr(v){ return Math.round(v).toLocaleString("id-ID"); }

  function totalFixed() {
    return Object.values(state.fixed).reduce((a,b)=>a+num(b),0);
  }

  function fixedPerUnit() {
    return totalFixed() / Math.max(1, state.asumsi.penjualan_unit_bulan);
  }

  function fixedPerDus() {
    return fixedPerUnit() * state.asumsi.faktor_dus;
  }

  function renderTabs() {
    const t = document.getElementById("tabs");
    t.innerHTML="";
    TABS.forEach(x=>{
      const b=document.createElement("button");
      b.className="tab"+(tab===x.id?" active":"");
      b.textContent=x.label;
      b.onclick=()=>{tab=x.id; render();};
      t.appendChild(b);
    });
  }

  function inputRow(label,val,onChange,isPct=false){
    const r=document.createElement("div");
    r.className="row";
    r.innerHTML=`
      <label>${label}</label>
      <input
        type="${isPct?"number":"text"}"
        inputmode="${isPct?"decimal":"numeric"}"
        pattern="${isPct?"":"[0-9]*"}"
        step="${isPct?"0.1":"1"}"
        data-autoselect="1"
        value="${val}"
      />
    `;
    const i=r.querySelector("input");
    i.addEventListener("focus",()=>i.select());
    i.addEventListener("input",()=>onChange(num(i.value)));
    return r;
  }

  function renderFix(){
    const c=card("Biaya Tetap (bulanan)");
    c.append(
      inputRow("Sewa warung",state.fixed.sewa,v=>state.fixed.sewa=v),
      inputRow("Tenaga kerja sendiri",state.fixed.tenaga,v=>state.fixed.tenaga=v),
      inputRow("Listrik & air",state.fixed.listrik,v=>state.fixed.listrik=v),
      inputRow("Internet / QRIS",state.fixed.internet,v=>state.fixed.internet=v),
      inputRow("Transport",state.fixed.transport,v=>state.fixed.transport=v),
      inputRow("Lain-lain / kehilangan",state.fixed.lain,v=>state.fixed.lain=v)
    );
    c.append(kpiBox("Total biaya tetap", idr(totalFixed())));
    view.append(c);
  }

  function renderAsumsi(){
    const c=card("Asumsi Utama");
    c.append(
      inputRow("Penjualan (unit/bulan)",state.asumsi.penjualan_unit_bulan,v=>state.asumsi.penjualan_unit_bulan=v),
      inputRow("Faktor biaya Dus",state.asumsi.faktor_dus,v=>state.asumsi.faktor_dus=v,true),
      inputRow("Biaya tetap Galon",state.asumsi.biaya_tetap_galon,v=>state.asumsi.biaya_tetap_galon=v),
      inputRow("Biaya variabel minuman",state.asumsi.biaya_variabel_minuman,v=>state.asumsi.biaya_variabel_minuman=v),
      inputRow("Susut minuman %",state.asumsi.susut_minuman,v=>state.asumsi.susut_minuman=v,true),
      inputRow("Susut Dus %",state.asumsi.susut_dus,v=>state.asumsi.susut_dus=v,true),
      inputRow("Susut buah %",state.asumsi.susut_buah,v=>state.asumsi.susut_buah=v,true),
      inputRow("Cuci Galon",state.asumsi.cuci_galon,v=>state.asumsi.cuci_galon=v),
      inputRow("Antar Galon",state.asumsi.antar_galon,v=>state.asumsi.antar_galon=v)
    );
    c.append(kpiBox("Biaya tetap per unit",n(idr(fixedPerUnit()))));
    view.append(c);
  }

  function renderCalc(){
    const c=card("Rechner");
    const sel=document.createElement("select");
    sel.innerHTML=`
      <option value="minuman">Minuman</option>
      <option value="dus">Dus</option>
      <option value="buah">Buah/Gemüse</option>
      <option value="galon">Galon</option>
    `;
    const ek=document.createElement("input");
    ek.type="text"; ek.inputMode="numeric"; ek.pattern="[0-9]*";
    ek.placeholder="Harga beli (EK)";
    const btn=document.createElement("button");
    btn.className="primary"; btn.textContent="Hitung";
    const out=document.createElement("div"); out.className="card";

    btn.onclick=()=>{
      const EK=num(ek.value);
      let susut=0, fix=0, extra=0;
      if(sel.value==="minuman"){susut=EK*state.asumsi.susut_minuman/100;fix=fixedPerUnit();extra=state.asumsi.biaya_variabel_minuman;}
      if(sel.value==="dus"){susut=EK*state.asumsi.susut_dus/100;fix=fixedPerDus();}
      if(sel.value==="buah"){susut=EK*state.asumsi.susut_buah/100;fix=fixedPerUnit();}
      if(sel.value==="galon"){fix=state.asumsi.biaya_tetap_galon;extra=state.asumsi.cuci_galon+state.asumsi.antar_galon;}
      const min=EK+susut+fix+extra;
      out.innerHTML=`<div class="big">${idr(min)} IDR</div><div class="muted">EK ${idr(EK)} · Susut ${idr(susut)} · Fix ${idr(fix)} · Extra ${idr(extra)}</div>`;
    };

    c.append(sel,ek,btn);
    view.append(c,out);
  }

  function card(t){const d=document.createElement("div");d.className="card";d.innerHTML=`<b>${t}</b>`;return d;}
  function kpiBox(l,v){const d=document.createElement("div");d.className="card";d.innerHTML=`<div class="muted">${l}</div><div class="big">${v}</div>`;return d;}

  const view=document.getElementById("view");
  document.getElementById("saveBtn").onclick=save;
  document.getElementById("exportBtn").onclick=()=>prompt("JSON",JSON.stringify(state,null,2));
  document.getElementById("importBtn").onclick=()=>{const j=prompt("JSON einfügen"); if(j){state=JSON.parse(j); render();}};

  function render(){
    renderTabs();
    view.innerHTML="";
    if(tab==="fix") renderFix();
    if(tab==="asumsi") renderAsumsi();
    if(tab==="calc") renderCalc();
  }

  render();
})();
</script>
</body>
</html>
