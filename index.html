<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warung Preisrechner</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#0b1220; color:#e5e7eb; }
    header { padding: 14px 16px; background:#111827; position: sticky; top:0; border-bottom:1px solid #1f2937;}
    h1 { font-size: 16px; margin:0; letter-spacing:.2px;}
    .tabs { display:flex; gap:8px; padding:10px 16px; background:#0b1220; position: sticky; top:52px; border-bottom:1px solid #1f2937; overflow:auto;}
    .tab { border:1px solid #1f2937; background:#0f172a; color:#e5e7eb; padding:8px 10px; border-radius:999px; font-size:13px; cursor:pointer; white-space:nowrap;}
    .tab.active { background:#2563eb; border-color:#2563eb; }
    main { padding: 14px 16px 90px; max-width: 820px; margin: 0 auto; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:12px; margin: 12px 0; }
    .row { display:grid; grid-template-columns: 1fr 170px; gap:10px; align-items:center; margin:10px 0; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    label { font-size:13px; color:#cbd5e1; }
    input, select, button, textarea {
      width:100%; box-sizing:border-box;
      padding:10px 10px; border-radius:10px;
      border:1px solid #334155; background:#0b1220; color:#e5e7eb;
      font-size:14px;
    }
    button { background:#1f2937; cursor:pointer; }
    button.primary { background:#2563eb; border-color:#2563eb; }
    button.danger { background:#b91c1c; border-color:#b91c1c; }
    .muted { color:#94a3b8; font-size:12px; }
    .kpi { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .kpi .box { background:#0b1220; border:1px solid #1f2937; padding:10px; border-radius:12px; }
    .big { font-size:18px; font-weight:700; margin-top:2px;}
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:12px; color:#cbd5e1;}
    .footerbar { position:fixed; left:0; right:0; bottom:0; background:#111827; border-top:1px solid #1f2937; padding:10px 16px; display:flex; gap:10px; }
    .footerbar button { flex:1; }
    .list { display:flex; flex-direction:column; gap:10px; }
    .groupItem { background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:10px; }
    .groupTop { display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .groupTop b { font-size:14px; }
    .inline { display:flex; gap:8px; }
    .inline > * { flex:1; }
    .hr { height:1px; background:#1f2937; margin:12px 0; }
    .ok { color:#34d399; }
  </style>
</head>
<body>
  <header>
    <h1>Warung Preisrechner (offline)</h1>
    <div class="muted">Fixkosten einzeln erfassen → Gruppen/Verluste → Mindestpreis berechnen</div>
  </header>

  <div class="tabs" id="tabs"></div>

  <main id="view"></main>

  <div class="footerbar">
    <button id="btnExport">JSON Export</button>
    <button id="btnImport">JSON Import</button>
    <button class="primary" id="btnSave">Speichern</button>
  </div>

<script>
(() => {
  const STORAGE_KEY = "warung_pricing_settings_v1";

  // --- Defaults (kannst du später 1:1 auf Excel-Felder umbauen)
  const DEFAULTS = {
    version: 1,
    currency: "IDR",
    base: {
      periode: "monat",
      verkaufsmenge_monat: 2500,        // Stück oder Transaktionen/Monat
      zielmarge_pct: 20,                // Marge vom Verkaufspreis
      variable_kosten_pct_vom_vk: 3,    // z.B. payment/packaging als % vom Verkaufspreis
      rundung_idr: 500                  // 0 = keine Rundung
    },
    fixed_costs: {
      miete: 1500000,
      strom: 350000,
      wasser: 150000,
      internet: 250000,
      transport: 500000,
      sonstiges: 200000
    },
    product_groups: [
      { id: "obst", name: "Obst", loss_pct: 8.0, active: true },
      { id: "gemuese", name: "Gemüse", loss_pct: 6.0, active: true },
      { id: "getraenke", name: "Getränke", loss_pct: 1.0, active: true },
      { id: "andere", name: "Andere", loss_pct: 2.0, active: true }
    ]
  };

  // --- State
  let state = load();

  const TABS = [
    { id: "fix", label: "1) Fixkosten" },
    { id: "base", label: "2) Basis" },
    { id: "groups", label: "3) Gruppen & Verluste" },
    { id: "calc", label: "4) Rechner" }
  ];
  let activeTab = "fix";

  // --- Helpers
  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return structuredClone(DEFAULTS);
      const obj = JSON.parse(raw);
      return mergeDefaults(structuredClone(DEFAULTS), obj);
    } catch (e) {
      return structuredClone(DEFAULTS);
    }
  }

  function mergeDefaults(def, obj) {
    // shallow + nested merge for our structure
    if (!obj || typeof obj !== "object") return def;
    def.version = obj.version ?? def.version;
    def.currency = obj.currency ?? def.currency;

    def.base = { ...def.base, ...(obj.base || {}) };
    def.fixed_costs = { ...def.fixed_costs, ...(obj.fixed_costs || {}) };

    if (Array.isArray(obj.product_groups)) {
      def.product_groups = obj.product_groups.map(g => ({
        id: String(g.id ?? "").trim() || slugify(g.name ?? "gruppe"),
        name: String(g.name ?? "Gruppe"),
        loss_pct: num(g.loss_pct, 0),
        active: g.active !== false
      }));
      if (def.product_groups.length === 0) def.product_groups = structuredClone(DEFAULTS.product_groups);
    }
    return def;
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state, null, 2));
    toast("Gespeichert ✅");
  }

  function num(v, fallback=0) {
    const x = Number(String(v).replace(",", "."));
    return Number.isFinite(x) ? x : fallback;
  }

  function moneyIDR(x) {
    const n = Math.round(x);
    return n.toLocaleString("id-ID");
  }

  function sumFixedCosts() {
    return Object.values(state.fixed_costs).reduce((a,b)=>a + num(b,0), 0);
  }

  function fixedCostPerSale() {
    const qty = Math.max(1, num(state.base.verkaufsmenge_monat, 1));
    return sumFixedCosts() / qty;
  }

  function roundIDR(x) {
    const r = Math.max(0, num(state.base.rundung_idr, 0));
    if (!r) return x;
    return Math.ceil(x / r) * r;
  }

  function slugify(s) {
    return String(s||"")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "")
      .slice(0, 40) || "gruppe";
  }

  function toast(msg) {
    // minimal: show in title area
    const h1 = document.querySelector("h1");
    const old = h1.textContent;
    h1.textContent = msg;
    setTimeout(()=>{ h1.textContent = old; }, 900);
  }

  // --- Rendering
  const tabsEl = document.getElementById("tabs");
  const viewEl = document.getElementById("view");
  const btnSave = document.getElementById("btnSave");
  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");

  function renderTabs() {
    tabsEl.innerHTML = "";
    TABS.forEach(t => {
      const b = document.createElement("button");
      b.className = "tab" + (t.id === activeTab ? " active" : "");
      b.textContent = t.label;
      b.onclick = () => { activeTab = t.id; render(); };
      tabsEl.appendChild(b);
    });
  }

  function render() {
    renderTabs();
    viewEl.innerHTML = "";
    if (activeTab === "fix") renderFix();
    if (activeTab === "base") renderBase();
    if (activeTab === "groups") renderGroups();
    if (activeTab === "calc") renderCalc();
  }

  function renderFix() {
    const card = elCard("Fixkosten (monatlich)", `
      <div class="muted">Einzelabfrage wie im Excel: Miete, Strom, Wasser, ...</div>
      <div class="hr"></div>
    `);

    const fields = [
      ["miete", "Miete / Monat"],
      ["strom", "Strom / Monat"],
      ["wasser", "Wasser / Monat"],
      ["internet", "Internet / Monat"],
      ["transport", "Transport / Monat"],
      ["sonstiges", "Sonstiges / Monat"]
    ];

    fields.forEach(([key, label]) => {
      card.appendChild(rowInput(label, state.fixed_costs[key], (v) => {
        state.fixed_costs[key] = num(v, 0);
        render(); // update KPIs live
      }, "number"));
    });

    const kpi = document.createElement("div");
    kpi.className = "kpi";
    kpi.innerHTML = `
      <div class="box">
        <div class="muted">Fixkosten gesamt / Monat</div>
        <div class="big">${moneyIDR(sumFixedCosts())} <span class="muted">${state.currency}</span></div>
      </div>
      <div class="box">
        <div class="muted">Fixkostenanteil pro Verkauf</div>
        <div class="big">${moneyIDR(fixedCostPerSale())} <span class="muted">${state.currency}</span></div>
      </div>
    `;
    card.appendChild(kpi);

    viewEl.appendChild(card);
    viewEl.appendChild(elCard("Hinweis", `
      <div class="muted">
        Wenn ihr im Excel weitere Fixkosten-Positionen habt (z.B. “Gaji/Personal”, “Sewa etalase”, “Izin”, …),
        sag mir die Liste – ich erweitere die Felder 1:1.
      </div>
    `));
  }

  function renderBase() {
    const card = elCard("Basis-Parameter", `<div class="muted">Diese Werte fließen in alle Produktberechnungen ein.</div><div class="hr"></div>`);

    card.appendChild(rowInput("Verkäufe / Monat (Stück oder Transaktionen)", state.base.verkaufsmenge_monat, (v)=> {
      state.base.verkaufsmenge_monat = Math.max(1, Math.floor(num(v, 1)));
      render();
    }, "number"));

    card.appendChild(rowInput("Zielmarge (%) vom Verkaufspreis", state.base.zielmarge_pct, (v)=> {
      state.base.zielmarge_pct = clampPct(num(v, 0));
      render();
    }, "number"));

    card.appendChild(rowInput("Variable Kosten (%) vom Verkaufspreis", state.base.variable_kosten_pct_vom_vk, (v)=> {
      state.base.variable_kosten_pct_vom_vk = clampPct(num(v, 0));
      render();
    }, "number"));

    card.appendChild(rowInput("Rundung (IDR) z.B. 0 / 500 / 1000", state.base.rundung_idr, (v)=> {
      state.base.rundung_idr = Math.max(0, Math.floor(num(v, 0)));
      render();
    }, "number"));

    const box = elCard("Live-Auswirkung", "");
    box.innerHTML += `
      <div class="kpi">
        <div class="box">
          <div class="muted">Fixkostenanteil pro Verkauf</div>
          <div class="big">${moneyIDR(fixedCostPerSale())} <span class="muted">${state.currency}</span></div>
        </div>
        <div class="box">
          <div class="muted">Marge + Variable (Summe)</div>
          <div class="big">${(num(state.base.zielmarge_pct)+num(state.base.variable_kosten_pct_vom_vk)).toFixed(1)}% <span class="muted">vom VK</span></div>
        </div>
      </div>
    `;

    viewEl.appendChild(card);
    viewEl.appendChild(box);

    function clampPct(x){ return Math.min(95, Math.max(0, x)); }
  }

  function renderGroups() {
    const card = elCard("Produktgruppen & Verlust (%)", `
      <div class="muted">Standard: Obst, Gemüse, Getränke, Andere. Später erweiterbar.</div>
      <div class="hr"></div>
    `);

    const list = document.createElement("div");
    list.className = "list";

    const groups = state.product_groups || [];
    groups.forEach((g, idx) => {
      const item = document.createElement("div");
      item.className = "groupItem";
      item.innerHTML = `
        <div class="groupTop">
          <div>
            <b>${escapeHtml(g.name)}</b>
            <div class="muted">ID: <span class="pill">${escapeHtml(g.id)}</span> ${g.active ? '<span class="pill ok">aktiv</span>' : '<span class="pill">inaktiv</span>'}</div>
          </div>
          <div style="min-width:150px">
            <label>Verlust %</label>
            <input type="number" step="0.1" value="${num(g.loss_pct,0)}" />
          </div>
        </div>
        <div class="inline" style="margin-top:10px">
          <button data-act="toggle">${g.active ? "Deaktivieren" : "Aktivieren"}</button>
          <button class="danger" data-act="del">Löschen</button>
        </div>
      `;

      const inp = item.querySelector("input");
      inp.oninput = () => {
        state.product_groups[idx].loss_pct = Math.max(0, num(inp.value, 0));
      };

      item.querySelector('[data-act="toggle"]').onclick = () => {
        state.product_groups[idx].active = !state.product_groups[idx].active;
        render();
      };

      item.querySelector('[data-act="del"]').onclick = () => {
        state.product_groups.splice(idx, 1);
        render();
      };

      list.appendChild(item);
    });

    const add = document.createElement("div");
    add.className = "card";
    add.innerHTML = `
      <div class="row3">
        <div>
          <label>Neue Gruppe (Name)</label>
          <input id="newName" placeholder="z.B. Hygiene" />
        </div>
        <div>
          <label>Verlust %</label>
          <input id="newLoss" type="number" step="0.1" value="2" />
        </div>
        <div style="display:flex; align-items:end;">
          <button class="primary" id="btnAdd">+ Hinzufügen</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">ID wird automatisch aus dem Namen gebildet.</div>
    `;

    add.querySelector("#btnAdd").onclick = () => {
      const name = add.querySelector("#newName").value.trim();
      const loss = Math.max(0, num(add.querySelector("#newLoss").value, 0));
      if (!name) return toast("Name fehlt");
      const id = slugify(name);
      if (state.product_groups.some(x => x.id === id)) return toast("ID existiert schon");
      state.product_groups.push({ id, name, loss_pct: loss, active: true });
      add.querySelector("#newName").value = "";
      render();
    };

    card.appendChild(list);
    viewEl.appendChild(card);
    viewEl.appendChild(add);
  }

  function renderCalc() {
    const activeGroups = (state.product_groups || []).filter(g => g.active);
    const card = elCard("Produkt-Rechner (Mindestpreis)", `
      <div class="muted">
        Formel (robust): Mindestpreis = (EK + Verlust + Fixkostenanteil) / (1 − variable% − marge%)
      </div>
      <div class="hr"></div>
    `);

    const form = document.createElement("div");

    // Inputs
    const groupRow = document.createElement("div");
    groupRow.className = "row";
    groupRow.innerHTML = `
      <label>Produktgruppe</label>
      <select id="grp"></select>
    `;
    const sel = groupRow.querySelector("select");
    activeGroups.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = `${g.name} (Verlust ${g.loss_pct}%)`;
      sel.appendChild(opt);
    });

    const ekRow = document.createElement("div");
    ekRow.className = "row";
    ekRow.innerHTML = `
      <label>Einkaufspreis (EK)</label>
      <input id="ek" type="number" step="1" placeholder="z.B. 3500" />
    `;

    const marketRow = document.createElement("div");
    marketRow.className = "row";
    marketRow.innerHTML = `
      <label>Optional: Marktpreis / Konkurrenz (VK)</label>
      <input id="mk" type="number" step="1" placeholder="z.B. 5000" />
    `;

    const btn = document.createElement("button");
    btn.className = "primary";
    btn.textContent = "Berechnen";

    const out = document.createElement("div");
    out.className = "card";
    out.innerHTML = `<div class="muted">Ergebnis erscheint hier.</div>`;

    btn.onclick = () => {
      const ek = Math.max(0, num(form.querySelector("#ek").value, 0));
      const grpId = sel.value;
      const grp = activeGroups.find(g => g.id === grpId) || activeGroups[0];
      const lossPct = num(grp?.loss_pct, 0) / 100;

      const loss = ek * lossPct;
      const fixPer = fixedCostPerSale();
      const varPct = num(state.base.variable_kosten_pct_vom_vk, 0) / 100;
      const marginPct = num(state.base.zielmarge_pct, 0) / 100;

      const denom = 1 - varPct - marginPct;
      if (denom <= 0.05) {
        out.innerHTML = `<b>Fehler:</b> Variable% + Marge% ist zu hoch (≥ 95%).`;
        return;
      }

      const minPrice = (ek + loss + fixPer) / denom;
      const suggested = roundIDR(minPrice);

      const market = Math.max(0, num(form.querySelector("#mk").value, 0));
      let marketInfo = "";
      if (market > 0) {
        const profit = market - (ek + loss + fixPer) - (market * varPct);
        const profitPct = (profit / market) * 100;
        marketInfo = `
          <div class="hr"></div>
          <div class="muted">Bei Marktpreis</div>
          <div><b>${moneyIDR(market)} ${state.currency}</b> → Gewinn ca. <b>${moneyIDR(profit)} ${state.currency}</b> (${profitPct.toFixed(1)}%)</div>
        `;
      }

      out.innerHTML = `
        <div class="kpi">
          <div class="box">
            <div class="muted">Mindestpreis (theoretisch)</div>
            <div class="big">${moneyIDR(minPrice)} <span class="muted">${state.currency}</span></div>
          </div>
          <div class="box">
            <div class="muted">Empfehlung (gerundet)</div>
            <div class="big">${moneyIDR(suggested)} <span class="muted">${state.currency}</span></div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="muted">Aufschlüsselung</div>
        <div>EK: <b>${moneyIDR(ek)}</b> · Verlust (${(lossPct*100).toFixed(1)}%): <b>${moneyIDR(loss)}</b> · Fix/Verkauf: <b>${moneyIDR(fixPer)}</b></div>
        <div class="muted">Variable: ${(varPct*100).toFixed(1)}% · Zielmarge: ${(marginPct*100).toFixed(1)}%</div>
        ${marketInfo}
      `;
    };

    form.appendChild(groupRow);
    form.appendChild(ekRow);
    form.appendChild(marketRow);
    form.appendChild(btn);

    card.appendChild(form);
    viewEl.appendChild(card);
    viewEl.appendChild(out);
  }

  // --- Components
  function elCard(title, html) {
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `<b>${title}</b><div style="margin-top:8px">${html || ""}</div>`;
    return d;
  }

  function rowInput(labelText, value, onChange, type="number") {
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <label>${labelText}</label>
      <input type="${type}" value="${num(value,0)}" />
    `;
    const inp = row.querySelector("input");
    inp.oninput = () => onChange(inp.value);
    return row;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // --- Export / Import
  btnSave.onclick = () => save();

  btnExport.onclick = async () => {
    const json = JSON.stringify(state, null, 2);
    try {
      await navigator.clipboard.writeText(json);
      toast("JSON kopiert ✅");
    } catch {
      prompt("Kopiere JSON:", json);
    }
  };

  btnImport.onclick = () => {
    const txt = prompt("JSON einfügen (überschreibt Einstellungen):");
    if (!txt) return;
    try {
      const obj = JSON.parse(txt);
      state = mergeDefaults(structuredClone(DEFAULTS), obj);
      save();
      render();
    } catch {
      toast("Ungültiges JSON");
    }
  };

  // Init
  render();

})();
</script>
</body>
</html>
