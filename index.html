<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pricing Tool</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#93a4c7; --text:#e9efff;
      --acc:#4da3ff; --ok:#41d19b; --warn:#ffcc66; --err:#ff6b6b;
      --border: rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 10% 10%, #16224a 0%, var(--bg) 50%, #070a14 100%);
      color: var(--text);
      overflow-x:hidden;
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 16px; }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    .title{ display:flex; flex-direction:column; gap:2px; }
    h1{ font-size: 20px; margin:0; letter-spacing:0.2px; }
    .sub{ color:var(--muted); font-size:13px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .pill{
      background: rgba(255,255,255,0.06);
      border:1px solid var(--border);
      padding:8px 10px;
      border-radius: 999px;
      display:flex; gap:10px; align-items:center;
    }
    select, button, input{ font: inherit; color: var(--text); }
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
    }
    button:hover{ border-color: rgba(255,255,255,0.2); }
    button.primary{
      background: linear-gradient(180deg, rgba(77,163,255,0.25), rgba(77,163,255,0.08));
      border-color: rgba(77,163,255,0.35);
    }
    button.danger{
      border-color: rgba(255,107,107,0.45);
      background: rgba(255,107,107,0.10);
    }
    .tabs{
      display:flex; gap:10px; margin: 14px 0;
      overflow-x:auto; padding-bottom: 4px; scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar{ display:none; }
    .tab{
      white-space:nowrap; padding:10px 12px; border-radius: 999px;
      border:1px solid var(--border); background: rgba(255,255,255,0.05);
      color: var(--muted);
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(77,163,255,0.35);
      background: rgba(77,163,255,0.12);
    }
    .card{
      background: rgba(18,26,51,0.75);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 14px;
      overflow:hidden;
    }
    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .col-12{ grid-column: span 12; }
    .col-8{ grid-column: span 8; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }
    .col-3{ grid-column: span 3; }
    @media (max-width: 820px){
      .col-8,.col-6,.col-4,.col-3{ grid-column: span 12; }
      header{ flex-direction:column; align-items:flex-start; }
    }
    label{ display:block; font-size:13px; color: var(--muted); margin-bottom:6px; }
    .field{
      width:100%;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
    }
    .field:focus{ border-color: rgba(77,163,255,0.45); }
    .hint{ font-size:12px; color: var(--muted); margin-top:6px; }
    .kpi{
      display:flex; flex-direction:column; gap:4px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      min-height: 74px;
    }
    .kpi .v{ font-size: 20px; font-weight: 700; }
    .kpi .t{ font-size: 12px; color: var(--muted); }
    .mono{ font-variant-numeric: tabular-nums; }
    .hr{ height:1px; background: var(--border); margin: 14px 0; }
    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(65,209,155,0.10);
      color: rgba(233,255,245,0.95);
      display:none;
    }
    .toast.show{ display:block; }
    .small{ font-size:12px; color: var(--muted); }
    .checkrow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .checkrow input[type="checkbox"]{ width:18px; height:18px; }

    /* Fix cost list */
    .list{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,0.03);
      overflow:hidden;
    }
    .listhead{
      display:grid;
      grid-template-columns: 1.4fr 1fr 90px;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      color: var(--muted);
      font-size:12px;
    }
    .listrow{
      display:grid;
      grid-template-columns: 1.4fr 1fr 90px;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      align-items:center;
    }
    .listrow:last-child{ border-bottom:none; }
    .btnsm{
      padding:8px 10px;
      border-radius: 12px;
      width: 90px;
      justify-self:end;
    }
    @media (max-width: 820px){
      .listhead, .listrow{
        grid-template-columns: 1fr;
      }
      .btnsm{ width: 100%; justify-self:stretch; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Pricing Tool</h1>
        <div class="sub" id="subtitle">Dynamic deckungskosten% based on purchase price and real fixed costs.</div>
      </div>

      <div class="row">
        <div class="pill">
          <span class="small" id="langLabel">Language</span>
          <select id="langSelect" class="field" style="padding:8px 10px;border-radius:999px">
            <option value="en">English</option>
            <option value="id">Bahasa Indonesia</option>
          </select>
        </div>
        <button class="primary" id="resetBtn">Reset</button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="fix" id="tabFix">Fix Costs</button>
      <button class="tab" data-tab="assum" id="tabAssum">Assumptions</button>
      <button class="tab" data-tab="calc" id="tabCalc">Calculator</button>
    </div>

    <!-- FIX COSTS -->
    <section class="card" id="pageFix">
      <div class="grid">
        <div class="col-12">
          <div class="small" id="fixExpl">
            Basis% is calculated from real fixed costs: Basis% = FixCostsTotal / TotalPurchase. Then we apply a smooth curve per item and clamp min/max.
          </div>
        </div>

        <!-- NEW: Fix cost calculation window -->
        <div class="col-12">
          <div class="kpi" style="gap:10px;">
            <div class="t" id="fixWindowTitle">Fixed costs calculator (items)</div>

            <div class="checkrow">
              <input type="checkbox" id="autoFixTotal" />
              <label for="autoFixTotal" id="lblAutoFixTotal" style="margin:0;color:var(--text)">Use items sum as “Fixed costs total”</label>
              <span class="small" id="autoFixTotalNote">(recommended)</span>
            </div>

            <div class="list" id="fixList">
              <div class="listhead">
                <div id="fixColName">Name</div>
                <div id="fixColAmount">Amount (IDR / month)</div>
                <div></div>
              </div>
              <div id="fixRows"></div>
            </div>

            <div class="row">
              <button class="primary" id="addFixRowBtn">+ Add item</button>
              <button id="fillFixExamplesBtn">Examples</button>
              <button class="danger" id="clearFixRowsBtn">Clear items</button>
            </div>

            <div class="row" style="align-items:center;">
              <div class="kpi" style="min-height:auto;">
                <div class="v mono" id="fixItemsSumOut">—</div>
                <div class="t" id="fixItemsSumOutT">Items sum (IDR / month)</div>
              </div>
              <div class="small" id="fixItemsHint">This sum can feed Fixed costs total automatically.</div>
            </div>
          </div>
        </div>

        <div class="col-6">
          <label id="lblFixTotal">Fixed costs total (IDR / month)</label>
          <input class="field num" id="fixTotal" inputmode="numeric" placeholder="5.000.000" />
          <div class="hint" id="hintFixTotal">Example: rent + salary + electricity etc (monthly).</div>
        </div>

        <div class="col-6">
          <label id="lblPurchaseTotal">Total purchase (IDR / month)</label>
          <input class="field num" id="purchaseTotal" inputmode="numeric" placeholder="50.000.000" />
          <div class="hint" id="hintPurchaseTotal">Sum of all COGS purchases for the month.</div>
        </div>

        <div class="col-12">
          <div class="checkrow">
            <input type="checkbox" id="autoBasis" />
            <label for="autoBasis" id="lblAutoBasis" style="margin:0;color:var(--text)">Auto-calculate Basis% from totals</label>
            <span class="small" id="autoBasisNote">(recommended)</span>
          </div>
        </div>

        <div class="col-3">
          <label id="lblBasis">Basis % (manual / fallback)</label>
          <input class="field num" id="basisPct" inputmode="decimal" placeholder="10" />
          <div class="hint" id="hintBasis">Used if Auto is OFF or totals are missing.</div>
        </div>

        <div class="col-3">
          <label id="lblBasisCalc">Basis % (calculated)</label>
          <div class="kpi">
            <div class="v mono" id="basisCalcOut">—</div>
            <div class="t" id="basisCalcOutT">FixTotal / PurchaseTotal</div>
          </div>
        </div>

        <div class="col-3">
          <label id="lblRef">Reference purchase (IDR)</label>
          <input class="field num" id="refPrice" inputmode="numeric" placeholder="10.000" />
          <div class="hint" id="hintRef">Typical average purchase price.</div>
        </div>

        <div class="col-3">
          <label id="lblFactor">Progression factor</label>
          <input class="field num" id="progFactor" inputmode="decimal" placeholder="0,3" />
          <div class="hint" id="hintFactor">Smooth increase strength.</div>
        </div>

        <div class="col-3">
          <label id="lblMin">Min %</label>
          <input class="field num" id="minPct" inputmode="decimal" placeholder="6" />
          <div class="hint" id="hintMin">Lower clamp.</div>
        </div>

        <div class="col-3">
          <label id="lblMax">Max %</label>
          <input class="field num" id="maxPct" inputmode="decimal" placeholder="15" />
          <div class="hint" id="hintMax">Upper clamp.</div>
        </div>

        <div class="col-6">
          <div class="kpi">
            <div class="t" id="kpiTitle">Quick test (enter a purchase price)</div>
            <div class="row" style="align-items:center; gap:12px;">
              <input class="field num" id="testPurchase" inputmode="numeric" placeholder="30.000" style="max-width:220px;" />
              <div class="v mono" id="kpiResult">—</div>
            </div>
            <div class="small" id="kpiFormula">Deckungskosten% = basis × (1 + factor × ln(price/ref + 1)) → clamp</div>
          </div>
        </div>

        <div class="col-12">
          <div class="hr"></div>
          <div class="row">
            <button class="primary" id="saveFixBtn">Save</button>
            <button id="loadFixBtn">Load saved</button>
            <span class="small" id="saveHint">Saved to your browser (localStorage). You can overwrite anytime.</span>
          </div>
          <div class="toast" id="toastFix">Saved.</div>
        </div>
      </div>
    </section>

    <!-- ASSUMPTIONS -->
    <section class="card" id="pageAssum" style="display:none;">
      <div class="grid">
        <div class="col-4">
          <label id="lblLoss">Loss / shrinkage %</label>
          <input class="field num" id="lossPct" inputmode="decimal" placeholder="2" />
          <div class="hint" id="hintLoss">Product loss / spoilage.</div>
        </div>
        <div class="col-4">
          <label id="lblMargin">Target margin %</label>
          <input class="field num" id="marginPct" inputmode="decimal" placeholder="20" />
          <div class="hint" id="hintMargin">Your desired gross margin.</div>
        </div>
        <div class="col-4">
          <label id="lblTax">Tax / misc % (optional)</label>
          <input class="field num" id="taxPct" inputmode="decimal" placeholder="0" />
          <div class="hint" id="hintTax">Optional extra %.</div>
        </div>

        <div class="col-12">
          <div class="hr"></div>
          <div class="row">
            <button class="primary" id="saveAssBtn">Save</button>
            <button id="loadAssBtn">Load saved</button>
            <span class="small" id="assHint">Saved to your browser. Editable anytime.</span>
          </div>
          <div class="toast" id="toastAss">Saved.</div>
        </div>
      </div>
    </section>

    <!-- CALCULATOR -->
    <section class="card" id="pageCalc" style="display:none;">
      <div class="grid">
        <div class="col-4">
          <label id="lblCategory">Category</label>
          <select class="field" id="category">
            <option value="beverage">Beverage / Minuman</option>
            <option value="fresh">Fresh food / Segar</option>
            <option value="snack">Snack</option>
            <option value="staple">Staples / Sembako</option>
            <option value="dryfood">Dryfood / Indomie etc</option>
            <option value="other">Other</option>
          </select>
          <div class="hint" id="hintCat">Category is for filtering later (optional).</div>
        </div>

        <div class="col-4">
          <label id="lblPurchase">Purchase price (IDR)</label>
          <input class="field num" id="purchasePrice" inputmode="numeric" placeholder="10.000" />
          <div class="hint" id="hintPurchase">Supplier price (COGS).</div>
        </div>

        <div class="col-4">
          <label id="lblCompetitor">Competitor price (IDR, optional)</label>
          <input class="field num" id="competitorPrice" inputmode="numeric" placeholder="—" />
          <div class="hint" id="hintCompetitor">If you want to compare.</div>
        </div>

        <div class="col-12"><div class="hr"></div></div>

        <div class="col-3">
          <div class="kpi">
            <div class="v mono" id="outDeckPct">—</div>
            <div class="t" id="outDeckPctT">Deckungskosten % (dynamic)</div>
          </div>
        </div>
        <div class="col-3">
          <div class="kpi">
            <div class="v mono" id="outDeckIDR">—</div>
            <div class="t" id="outDeckIDRT">Deckungskosten (IDR)</div>
          </div>
        </div>
        <div class="col-3">
          <div class="kpi">
            <div class="v mono" id="outMarginPct">—</div>
            <div class="t" id="outMarginPctT">Target margin %</div>
          </div>
        </div>
        <div class="col-3">
          <div class="kpi">
            <div class="v mono" id="outMinPrice">—</div>
            <div class="t" id="outMinPriceT">Minimum selling price</div>
          </div>
        </div>

        <div class="col-12">
          <div class="small" id="calcNote">
            Formula: Minimum Price = Purchase / (1 - (Deck% + Loss% + Tax% + Margin%)).
          </div>
        </div>
      </div>
    </section>

    <div class="small" style="margin-top:12px;">
      <span id="footerNote">Tip: Tap/click a number field to edit raw digits; it formats with dots when you leave the field.</span>
    </div>
  </div>

<script>
/** ---------- Helpers ---------- */
function formatIDRInt(n){
  if (!isFinite(n)) return "";
  const s = Math.round(n).toString();
  return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
function parseNumberLoose(str){
  if (str == null) return NaN;
  const cleaned = String(str).trim()
    .replace(/\s+/g,"")
    .replace(/\./g,"")
    .replace(/,/g,".");
  if (cleaned === "") return NaN;
  const n = Number(cleaned);
  return isFinite(n) ? n : NaN;
}
function pctToUnit(pct){ return pct / 100; }
function unitToPct(unit){ return unit * 100; }

/** ---------- Dynamic Deckungskosten% ---------- */
function dynamicDeckPctUnit(purchase, basisUnit, ref, factor, minUnit, maxUnit){
  if (!(purchase > 0) || !(ref > 0) || !isFinite(factor) || !isFinite(basisUnit)) return NaN;
  const raw = basisUnit * (1 + factor * Math.log(purchase / ref + 1));
  return Math.min(maxUnit, Math.max(minUnit, raw));
}

/** ---------- Storage ---------- */
const KEYS = {
  fix: "pricing_tool_fix_v4",
  assum: "pricing_tool_assum_v4",
  lang: "pricing_tool_lang_v4",
};
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadJSON(key){
  try{ return JSON.parse(localStorage.getItem(key) || "null"); }
  catch(e){ return null; }
}

/** ---------- i18n (only additions for window labels) ---------- */
const I18N = {
  en: {
    subtitle: "Dynamic deckungskosten% based on purchase price and real fixed costs.",
    langLabel:"Language", tabFix:"Fix Costs", tabAssum:"Assumptions", tabCalc:"Calculator", reset:"Reset",
    fixExpl:"Basis% is calculated from real fixed costs: Basis% = FixCostsTotal / TotalPurchase. Then we apply a smooth curve per item and clamp min/max.",
    fixWindowTitle:"Fixed costs calculator (items)",
    lblAutoFixTotal:"Use items sum as “Fixed costs total”", autoFixTotalNote:"(recommended)",
    fixColName:"Name", fixColAmount:"Amount (IDR / month)",
    fixItemsSumOutT:"Items sum (IDR / month)",
    fixItemsHint:"This sum can feed Fixed costs total automatically.",
    addItem:"+ Add item", examples:"Examples", clearItems:"Clear items",

    lblFixTotal:"Fixed costs total (IDR / month)", hintFixTotal:"Example: rent + salary + electricity etc (monthly).",
    lblPurchaseTotal:"Total purchase (IDR / month)", hintPurchaseTotal:"Sum of all COGS purchases for the month.",
    lblAutoBasis:"Auto-calculate Basis% from totals", autoBasisNote:"(recommended)",
    lblBasis:"Basis % (manual / fallback)", hintBasis:"Used if Auto is OFF or totals are missing.",
    lblBasisCalc:"Basis % (calculated)", basisCalcOutT:"FixTotal / PurchaseTotal",
    lblRef:"Reference purchase (IDR)", hintRef:"Typical average purchase price.",
    lblFactor:"Progression factor", hintFactor:"Smooth increase strength.",
    lblMin:"Min %", hintMin:"Lower clamp.", lblMax:"Max %", hintMax:"Upper clamp.",
    kpiTitle:"Quick test (enter a purchase price)", kpiFormula:"Deckungskosten% = basis × (1 + factor × ln(price/ref + 1)) → clamp",
    save:"Save", load:"Load saved", saveHint:"Saved to your browser (localStorage). You can overwrite anytime.", saved:"Saved.",
    lblLoss:"Loss / shrinkage %", hintLoss:"Product loss / spoilage.",
    lblMargin:"Target margin %", hintMargin:"Your desired gross margin.",
    lblTax:"Tax / misc % (optional)", hintTax:"Optional extra %.",
    assHint:"Saved to your browser. Editable anytime.",
    lblCategory:"Category", hintCat:"Category is for filtering later (optional).",
    lblPurchase:"Purchase price (IDR)", hintPurchase:"Supplier price (COGS).",
    lblCompetitor:"Competitor price (IDR, optional)", hintCompetitor:"If you want to compare.",
    outDeckPctT:"Deckungskosten % (dynamic)", outDeckIDRT:"Deckungskosten (IDR)",
    outMarginPctT:"Target margin %", outMinPriceT:"Minimum selling price",
    calcNote:"Formula: Minimum Price = Purchase / (1 - (Deck% + Loss% + Tax% + Margin%)).",
    footerNote:"Tip: Tap/click a number field to edit raw digits; it formats with dots when you leave the field.",
    remove:"Remove",
    namePlaceholder:"e.g. Rent",
  },
  id: {
    subtitle: "% biaya tetap dinamis berdasarkan harga beli & biaya tetap nyata.",
    langLabel:"Bahasa", tabFix:"Biaya Tetap", tabAssum:"Asumsi", tabCalc:"Kalkulator", reset:"Reset",
    fixExpl:"Basis% dihitung dari biaya tetap nyata: Basis% = Total Biaya Tetap / Total Pembelian. Lalu pakai kurva halus per item + batas min/maks.",
    fixWindowTitle:"Kalkulator biaya tetap (item)",
    lblAutoFixTotal:"Pakai total item sebagai “Total biaya tetap”", autoFixTotalNote:"(disarankan)",
    fixColName:"Nama", fixColAmount:"Jumlah (IDR / bulan)",
    fixItemsSumOutT:"Total item (IDR / bulan)",
    fixItemsHint:"Total ini bisa otomatis mengisi Total biaya tetap.",
    addItem:"+ Tambah item", examples:"Contoh", clearItems:"Hapus item",

    lblFixTotal:"Total biaya tetap (IDR / bulan)", hintFixTotal:"Contoh: sewa + gaji + listrik (bulanan).",
    lblPurchaseTotal:"Total pembelian/HPP (IDR / bulan)", hintPurchaseTotal:"Jumlah seluruh pembelian barang (HPP) per bulan.",
    lblAutoBasis:"Hitung Basis% otomatis dari total", autoBasisNote:"(disarankan)",
    lblBasis:"Basis % (manual / cadangan)", hintBasis:"Dipakai jika Auto OFF atau total kosong.",
    lblBasisCalc:"Basis % (hasil hitung)", basisCalcOutT:"BiayaTetap / PembelianTotal",
    lblRef:"Harga referensi (IDR)", hintRef:"Rata-rata harga beli tipikal.",
    lblFactor:"Faktor progresi", hintFactor:"Kekuatan kenaikan halus.",
    lblMin:"Min %", hintMin:"Batas bawah.", lblMax:"Maks %", hintMax:"Batas atas.",
    kpiTitle:"Tes cepat (isi harga beli)", kpiFormula:"% = basis × (1 + faktor × ln(harga/ref + 1)) → clamp",
    save:"Simpan", load:"Muat", saveHint:"Disimpan di browser (localStorage). Bisa diubah kapan saja.", saved:"Tersimpan.",
    lblLoss:"Susut / rusak %", hintLoss:"Kerusakan / kedaluwarsa.",
    lblMargin:"Target margin %", hintMargin:"Margin kotor yang diinginkan.",
    lblTax:"Pajak / lain-lain % (opsional)", hintTax:"Tambahan % opsional.",
    assHint:"Disimpan di browser. Bisa diedit kapan saja.",
    lblCategory:"Kategori", hintCat:"Kategori untuk filter nanti (opsional).",
    lblPurchase:"Harga beli (IDR)", hintPurchase:"Harga dari supplier (HPP).",
    lblCompetitor:"Harga pesaing (IDR, opsional)", hintCompetitor:"Untuk perbandingan.",
    outDeckPctT:"% Biaya tetap (dinamis)", outDeckIDRT:"Biaya tetap (IDR)",
    outMarginPctT:"% Margin target", outMinPriceT:"Harga jual minimum",
    calcNote:"Rumus: Harga Minimum = Harga Beli / (1 - (Deck% + Susut% + Pajak% + Margin%)).",
    footerNote:"Tip: Klik/ketuk angka untuk edit; akan diformat pakai titik saat keluar dari field.",
    remove:"Hapus",
    namePlaceholder:"mis. Sewa",
  }
};

/** ---------- Elements ---------- */
const el = (id)=>document.getElementById(id);
const pages = { fix: el("pageFix"), assum: el("pageAssum"), calc: el("pageCalc") };

/** ---------- Numeric input behavior ---------- */
function attachNumericBehavior(root=document){
  const numInputs = root.querySelectorAll("input.num");
  numInputs.forEach(inp=>{
    if (inp.dataset.bound === "1") return;
    inp.dataset.bound = "1";

    inp.addEventListener("focus", ()=>{
      const n = parseNumberLoose(inp.value);
      if (isFinite(n)) {
        const wantsDecimal = /[,\.]\d/.test(String(inp.value));
        inp.value = wantsDecimal ? String(n).replace(".", ",") : String(Math.trunc(n));
      }
    });
    inp.addEventListener("blur", ()=>{
      const id = inp.id;
      const n = parseNumberLoose(inp.value);
      if (!isFinite(n)) { inp.value=""; updateAll(); return; }

      const isIDR = ["fixTotal","purchaseTotal","refPrice","testPurchase","purchasePrice","competitorPrice"].includes(id)
        || inp.dataset.type === "idr";

      if (isIDR){
        inp.value = formatIDRInt(n);
      } else {
        const s = (Math.round(n*100)/100).toString().replace(".", ",");
        inp.value = s;
      }
      updateAll();
    });
    inp.addEventListener("input", ()=> updateAll(true));
  });
}

/** ---------- Tabs ---------- */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.dataset.tab;
    Object.keys(pages).forEach(k=>pages[k].style.display = (k===t) ? "" : "none");
  });
});

/** ---------- Fix cost items model ---------- */
let fixItems = []; // {id, name, amount}

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function defaultFixItems(){
  return [
    { id: uid(), name: "Rent / Sewa", amount: 2000000 },
    { id: uid(), name: "Electricity / Listrik", amount: 400000 },
    { id: uid(), name: "Internet", amount: 300000 },
    { id: uid(), name: "Staff / Gaji", amount: 2000000 },
  ];
}

function renderFixRows(){
  const rows = el("fixRows");
  rows.innerHTML = "";

  const lang = (loadJSON(KEYS.lang)?.lang) || "en";
  const t = I18N[lang] || I18N.en;

  fixItems.forEach(item=>{
    const row = document.createElement("div");
    row.className = "listrow";
    row.dataset.id = item.id;

    const name = document.createElement("input");
    name.className = "field";
    name.value = item.name || "";
    name.placeholder = t.namePlaceholder;

    const amount = document.createElement("input");
    amount.className = "field num";
    amount.dataset.type = "idr";
    amount.inputMode = "numeric";
    amount.value = isFinite(item.amount) ? formatIDRInt(item.amount) : "";

    const del = document.createElement("button");
    del.className = "btnsm danger";
    del.textContent = t.remove;

    name.addEventListener("input", ()=>{
      item.name = name.value;
      // no need updateAll
    });

    amount.addEventListener("blur", ()=>{
      item.amount = parseNumberLoose(amount.value);
      updateAll();
    });
    amount.addEventListener("input", ()=>{
      // allow live recalc while typing (optional)
      item.amount = parseNumberLoose(amount.value);
      updateAll(true);
    });

    del.addEventListener("click", ()=>{
      fixItems = fixItems.filter(x=>x.id !== item.id);
      renderFixRows();
      updateAll();
    });

    row.appendChild(name);
    row.appendChild(amount);
    row.appendChild(del);
    rows.appendChild(row);
  });

  attachNumericBehavior(rows);
}

function sumFixItems(){
  let s = 0;
  for (const it of fixItems){
    const a = Number(it.amount);
    if (isFinite(a) && a > 0) s += a;
  }
  return s;
}

/** ---------- Save/Load ---------- */
function showToast(id){
  const t = el(id);
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1200);
}

function readFixInputs(){
  return {
    fixTotal: parseNumberLoose(el("fixTotal").value),
    purchaseTotal: parseNumberLoose(el("purchaseTotal").value),
    autoBasis: !!el("autoBasis").checked,
    basisPct: parseNumberLoose(el("basisPct").value),
    refPrice: parseNumberLoose(el("refPrice").value),
    progFactor: parseNumberLoose(el("progFactor").value),
    minPct: parseNumberLoose(el("minPct").value),
    maxPct: parseNumberLoose(el("maxPct").value),
    autoFixTotal: !!el("autoFixTotal").checked,
    fixItems: fixItems
  };
}
function writeFixInputs(d){
  if (isFinite(d.fixTotal)) el("fixTotal").value = formatIDRInt(d.fixTotal);
  if (isFinite(d.purchaseTotal)) el("purchaseTotal").value = formatIDRInt(d.purchaseTotal);
  el("autoBasis").checked = !!d.autoBasis;
  if (isFinite(d.basisPct)) el("basisPct").value = String(d.basisPct).replace(".", ",");
  if (isFinite(d.refPrice)) el("refPrice").value = formatIDRInt(d.refPrice);
  if (isFinite(d.progFactor)) el("progFactor").value = String(d.progFactor).replace(".", ",");
  if (isFinite(d.minPct)) el("minPct").value = String(d.minPct).replace(".", ",");
  if (isFinite(d.maxPct)) el("maxPct").value = String(d.maxPct).replace(".", ",");
  el("autoFixTotal").checked = !!d.autoFixTotal;

  if (Array.isArray(d.fixItems) && d.fixItems.length){
    fixItems = d.fixItems.map(x=>({
      id: x.id || uid(),
      name: String(x.name || ""),
      amount: parseNumberLoose(x.amount)
    }));
  }
  renderFixRows();
}

function readAssumInputs(){
  return {
    lossPct: parseNumberLoose(el("lossPct").value),
    marginPct: parseNumberLoose(el("marginPct").value),
    taxPct: parseNumberLoose(el("taxPct").value)
  };
}
function writeAssumInputs(d){
  if (isFinite(d.lossPct)) el("lossPct").value = String(d.lossPct).replace(".", ",");
  if (isFinite(d.marginPct)) el("marginPct").value = String(d.marginPct).replace(".", ",");
  if (isFinite(d.taxPct)) el("taxPct").value = String(d.taxPct).replace(".", ",");
}

el("saveFixBtn").addEventListener("click", ()=>{
  saveJSON(KEYS.fix, readFixInputs());
  showToast("toastFix");
});
el("loadFixBtn").addEventListener("click", ()=>{
  const data = loadJSON(KEYS.fix);
  if (data) writeFixInputs(data);
  updateAll();
});
el("saveAssBtn").addEventListener("click", ()=>{
  saveJSON(KEYS.assum, readAssumInputs());
  showToast("toastAss");
});
el("loadAssBtn").addEventListener("click", ()=>{
  const data = loadJSON(KEYS.assum);
  if (data) writeAssumInputs(data);
  updateAll();
});

el("resetBtn").addEventListener("click", ()=>{
  localStorage.removeItem(KEYS.fix);
  localStorage.removeItem(KEYS.assum);
  setDefaults();
  updateAll();
});

/** ---------- Defaults ---------- */
function setDefaults(){
  // fix items
  fixItems = defaultFixItems();
  renderFixRows();

  el("autoFixTotal").checked = true;

  el("fixTotal").value = "5.000.000";
  el("purchaseTotal").value = "50.000.000";
  el("autoBasis").checked = true;

  el("basisPct").value = "10";
  el("refPrice").value = "10.000";
  el("progFactor").value = "0,3";
  el("minPct").value = "6";
  el("maxPct").value = "15";
  el("testPurchase").value = "30.000";

  el("lossPct").value = "2";
  el("marginPct").value = "20";
  el("taxPct").value = "0";

  el("purchasePrice").value = "10.000";
  el("competitorPrice").value = "";
}

/** ---------- Basis calculation ---------- */
function calcBasisUnit(fixTotal, purchaseTotal, manualBasisPct, autoBasis){
  const canAuto = autoBasis && (fixTotal > 0) && (purchaseTotal > 0);
  if (canAuto) return fixTotal / purchaseTotal;
  return pctToUnit(manualBasisPct || 0);
}

/** ---------- Main calc ---------- */
function updateAll(){
  // items sum & optionally feed fixTotal
  const itemsSum = sumFixItems();
  el("fixItemsSumOut").textContent = formatIDRInt(itemsSum) + " IDR";

  if (el("autoFixTotal").checked){
    // only overwrite if sum > 0 (prevents annoying zero overwrite)
    if (itemsSum > 0){
      el("fixTotal").value = formatIDRInt(itemsSum);
    }
  }

  const f = {
    fixTotal: parseNumberLoose(el("fixTotal").value),
    purchaseTotal: parseNumberLoose(el("purchaseTotal").value),
    autoBasis: el("autoBasis").checked,
    basisPct: parseNumberLoose(el("basisPct").value),
    refPrice: parseNumberLoose(el("refPrice").value),
    progFactor: parseNumberLoose(el("progFactor").value),
    minPct: parseNumberLoose(el("minPct").value),
    maxPct: parseNumberLoose(el("maxPct").value)
  };

  const basisUnit = calcBasisUnit(f.fixTotal, f.purchaseTotal, f.basisPct, f.autoBasis);
  const basisPctCalc = isFinite(basisUnit) ? unitToPct(basisUnit) : NaN;
  el("basisCalcOut").textContent = isFinite(basisPctCalc) ? (basisPctCalc.toFixed(2).replace(".", ",") + " %") : "—";

  const minU = pctToUnit(f.minPct || 0);
  const maxU = pctToUnit(f.maxPct || 0);

  // quick test
  const testP = parseNumberLoose(el("testPurchase").value);
  const deckTestU = dynamicDeckPctUnit(testP, basisUnit, f.refPrice, f.progFactor || 0, minU, maxU);
  el("kpiResult").textContent = isFinite(deckTestU)
    ? (unitToPct(deckTestU).toFixed(1).replace(".", ",") + " %")
    : "—";

  // assumptions
  const lossU = pctToUnit(parseNumberLoose(el("lossPct").value) || 0);
  const marginU = pctToUnit(parseNumberLoose(el("marginPct").value) || 0);
  const taxU = pctToUnit(parseNumberLoose(el("taxPct").value) || 0);

  // calculator purchase
  const purchase = parseNumberLoose(el("purchasePrice").value);
  const deckU = dynamicDeckPctUnit(purchase, basisUnit, f.refPrice, f.progFactor || 0, minU, maxU);

  el("outDeckPct").textContent = isFinite(deckU) ? (unitToPct(deckU).toFixed(1).replace(".", ",") + " %") : "—";
  el("outDeckIDR").textContent = (purchase > 0 && isFinite(deckU)) ? (formatIDRInt(purchase * deckU) + " IDR") : "—";
  el("outMarginPct").textContent = (unitToPct(marginU).toFixed(1).replace(".", ",") + " %");

  const totalU = (isFinite(deckU)?deckU:0) + lossU + taxU + marginU;
  let minPrice = NaN;
  if (purchase > 0 && totalU < 0.95){
    minPrice = purchase / (1 - totalU);
  }
  el("outMinPrice").textContent = isFinite(minPrice) ? formatIDRInt(minPrice) + " IDR" : "—";
}

/** ---------- Language apply ---------- */
function applyLang(lang){
  const t = (I18N[lang] || I18N.en);

  el("subtitle").textContent = t.subtitle;
  el("langLabel").textContent = t.langLabel;
  el("tabFix").textContent = t.tabFix;
  el("tabAssum").textContent = t.tabAssum;
  el("tabCalc").textContent = t.tabCalc;
  el("resetBtn").textContent = t.reset;

  el("fixExpl").textContent = t.fixExpl;

  // new window labels
  el("fixWindowTitle").textContent = t.fixWindowTitle;
  el("lblAutoFixTotal").textContent = t.lblAutoFixTotal;
  el("autoFixTotalNote").textContent = t.autoFixTotalNote;
  el("fixColName").textContent = t.fixColName;
  el("fixColAmount").textContent = t.fixColAmount;
  el("fixItemsSumOutT").textContent = t.fixItemsSumOutT;
  el("fixItemsHint").textContent = t.fixItemsHint;
  el("addFixRowBtn").textContent = t.addItem;
  el("fillFixExamplesBtn").textContent = t.examples;
  el("clearFixRowsBtn").textContent = t.clearItems;

  el("lblFixTotal").textContent = t.lblFixTotal;
  el("hintFixTotal").textContent = t.hintFixTotal;
  el("lblPurchaseTotal").textContent = t.lblPurchaseTotal;
  el("hintPurchaseTotal").textContent = t.hintPurchaseTotal;

  el("lblAutoBasis").textContent = t.lblAutoBasis;
  el("autoBasisNote").textContent = t.autoBasisNote;

  el("lblBasis").textContent = t.lblBasis;
  el("hintBasis").textContent = t.hintBasis;
  el("lblBasisCalc").textContent = t.lblBasisCalc;
  el("basisCalcOutT").textContent = t.basisCalcOutT;

  el("lblRef").textContent = t.lblRef;
  el("hintRef").textContent = t.hintRef;
  el("lblFactor").textContent = t.lblFactor;
  el("hintFactor").textContent = t.hintFactor;
  el("lblMin").textContent = t.lblMin;
  el("hintMin").textContent = t.hintMin;
  el("lblMax").textContent = t.lblMax;
  el("hintMax").textContent = t.hintMax;

  el("kpiTitle").textContent = t.kpiTitle;
  el("kpiFormula").textContent = t.kpiFormula;

  el("saveFixBtn").textContent = t.save;
  el("loadFixBtn").textContent = t.load;
  el("saveHint").textContent = t.saveHint;
  el("toastFix").textContent = t.saved;

  el("lblLoss").textContent = t.lblLoss;
  el("hintLoss").textContent = t.hintLoss;
  el("lblMargin").textContent = t.lblMargin;
  el("hintMargin").textContent = t.hintMargin;
  el("lblTax").textContent = t.lblTax;
  el("hintTax").textContent = t.hintTax;
  el("saveAssBtn").textContent = t.save;
  el("loadAssBtn").textContent = t.load;
  el("assHint").textContent = t.assHint;
  el("toastAss").textContent = t.saved;

  el("lblCategory").textContent = t.lblCategory;
  el("hintCat").textContent = t.hintCat;
  el("lblPurchase").textContent = t.lblPurchase;
  el("hintPurchase").textContent = t.hintPurchase;
  el("lblCompetitor").textContent = t.lblCompetitor;
  el("hintCompetitor").textContent = t.hintCompetitor;

  el("outDeckPctT").textContent = t.outDeckPctT;
  el("outDeckIDRT").textContent = t.outDeckIDRT;
  el("outMarginPctT").textContent = t.outMarginPctT;
  el("outMinPriceT").textContent = t.outMinPriceT;
  el("calcNote").textContent = t.calcNote;
  el("footerNote").textContent = t.footerNote;

  saveJSON(KEYS.lang, {lang});

  // re-render rows for translated placeholders/buttons
  renderFixRows();
}

/** ---------- Buttons for fix items ---------- */
el("addFixRowBtn").addEventListener("click", ()=>{
  fixItems.push({ id: uid(), name: "", amount: NaN });
  renderFixRows();
  updateAll();
});

el("fillFixExamplesBtn").addEventListener("click", ()=>{
  fixItems = defaultFixItems();
  renderFixRows();
  updateAll();
});

el("clearFixRowsBtn").addEventListener("click", ()=>{
  fixItems = [];
  renderFixRows();
  updateAll();
});

el("autoFixTotal").addEventListener("change", ()=> updateAll());
el("autoBasis").addEventListener("change", ()=> updateAll());

/** ---------- Init ---------- */
(function init(){
  attachNumericBehavior();

  // tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const t = btn.dataset.tab;
      Object.keys(pages).forEach(k=>pages[k].style.display = (k===t) ? "" : "none");
    });
  });

  // load language
  const langSaved = loadJSON(KEYS.lang);
  const lang = (langSaved && langSaved.lang) ? langSaved.lang : "en";
  el("langSelect").value = lang;

  // defaults
  setDefaults();

  // load saved
  const fixSaved = loadJSON(KEYS.fix);
  const assSaved = loadJSON(KEYS.assum);
  if (fixSaved) writeFixInputs(fixSaved);
  if (assSaved) writeAssumInputs(assSaved);

  // apply lang after rows exist
  applyLang(lang);

  // events
  el("langSelect").addEventListener("change", (e)=> applyLang(e.target.value));

  updateAll();
})();
</script>
</body>
</html>
