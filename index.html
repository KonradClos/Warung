<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warung Pricing</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    * { box-sizing: border-box; }
    body { margin:0; background:#0b1220; color:#e5e7eb; overflow-x: hidden; }

    header {
      padding:14px 16px;
      background:#111827;
      border-bottom:1px solid #1f2937;
      position: sticky; top:0; z-index: 10;
    }
    h1 { margin:0; font-size:16px; }
    .muted { color:#94a3b8; font-size:12px; }

    .topbar { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:8px; flex-wrap: wrap; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #1f2937; background:#0f172a; }
    .pill select { border:none; background:transparent; color:#e5e7eb; padding:0; width:auto; }

    .tabs {
      display:flex; gap:8px; padding:10px 16px;
      border-bottom:1px solid #1f2937; overflow:auto;
      position: sticky; top:82px; background:#0b1220; z-index: 9;
    }
    .tab {
      padding:8px 12px; border-radius:999px;
      border:1px solid #1f2937; background:#0f172a; color:#e5e7eb;
      cursor:pointer; white-space: nowrap;
    }
    .tab.active { background:#2563eb; border-color:#2563eb; }

    main { padding:16px 16px 90px; max-width:900px; margin:auto; }

    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:12px; margin-bottom:12px; overflow:hidden; }
    .row { display:grid; grid-template-columns: 1fr 260px; gap:12px; align-items:center; margin:12px 0; }
    label { font-size:13px; color:#cbd5e1; }

    input, select, button {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #334155;
      background:#0b1220;
      color:#e5e7eb;
      font-size:14px;
    }
    button { background:#1f2937; cursor:pointer; }
    button.primary { background:#2563eb; border-color:#2563eb; }

    .kpi { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px; }
    .kpi .box { background:#0b1220; border:1px solid #1f2937; padding:10px; border-radius:12px; }
    .big { font-size:18px; font-weight:700; }
    .hr { height:1px; background:#1f2937; margin:12px 0; }

    .footer {
      position:fixed; bottom:0; left:0; right:0;
      background:#111827; border-top:1px solid #1f2937;
      padding:10px 16px; display:flex; gap:10px; z-index: 11;
    }
    .footer button { flex:1; }

    /* Mobile: stack rows, no horizontal scroll */
    @media (max-width: 600px) {
      .tabs { top: 98px; }
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header>
  <h1 id="title">Warung Pricing</h1>
  <div class="topbar">
    <div class="muted" id="subtitle"></div>
    <div class="pill">
      <span class="muted" id="langLabel">Language</span>
      <select id="langSel" aria-label="Language">
        <option value="id">Bahasa</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>
</header>

<div class="tabs" id="tabs"></div>
<main id="view"></main>

<div class="footer">
  <button id="exportBtn">JSON Export</button>
  <button id="importBtn">JSON Import</button>
  <button class="primary" id="saveBtn">Save</button>
</div>

<script>
(() => {
  const KEY = "warung_pricing_excel_model_v3";

  // ---------- i18n ----------
  const I18N = {
    en: {
      title: "Warung Pricing",
      subtitle: "Excel-based model · manual product type · works offline",
      langLabel: "Language",
      tabs: { fix: "1) Fixed Costs", asumsi: "2) Assumptions", calc: "3) Calculator" },
      buttons: { export: "JSON Export", import: "JSON Import", save: "Save" },
      saved: "Saved ✅",
      cards: { fixed: "Monthly Fixed Costs", asumsi: "Main Assumptions (Excel)", calc: "Calculator (Manual Type)", breakdown: "Breakdown" },
      labels: {
        sewa: "Rent (warung) / month",
        tenaga: "Own labor (calculation) / month",
        listrik: "Electricity & water / month",
        internet: "Internet / QRIS / month",
        transport: "Transport / month",
        lain: "Other / losses / month",

        penjualan: "Sales (units/month total)",
        faktorDus: "Fixed-cost share for Dus (factor)",
        tetapGalon: "Fixed cost per Galon (IDR/sale)",
        varMinuman: "Variable beverage cost (IDR)",
        susutMinuman: "Shrinkage beverage (%)",
        susutDus: "Shrinkage Dus (%)",
        susutBuah: "Shrinkage fruit/veg (%)",
        susutInstant: "Shrinkage instant food (%)",
        cuciGalon: "Wash/shrink Galon (IDR)",
        antarGalon: "Delivery Galon (IDR)",
        round: "Rounding (IDR) 0 / 500 / 1000",

        type: "Product type",
        ek: "Purchase price (EK) IDR"
      },
      kpis: {
        totalFixed: "Total fixed costs / month",
        fixedPerUnit: "Fixed cost per unit (auto)",
        fixedPerDus: "Fixed cost per Dus transaction (auto)"
      },
      types: {
        minuman: "Beverage (single sale)",
        dus: "Dus / Carton (Dus transaction)",
        buah: "Fruit / Vegetables",
        instant: "Instant food (Tryfood/Indomie)",
        galon: "Galon"
      },
      calcBtn: "Calculate",
      enterEK: "Please enter EK."
    },

    id: {
      title: "Kalkulator Harga Warung",
      subtitle: "Model Excel · pilih tipe manual · bisa offline",
      langLabel: "Bahasa",
      tabs: { fix: "1) Biaya Tetap", asumsi: "2) Asumsi", calc: "3) Kalkulator" },
      buttons: { export: "Export JSON", import: "Import JSON", save: "Simpan" },
      saved: "Tersimpan ✅",
      cards: { fixed: "Biaya Tetap (bulanan)", asumsi: "Asumsi Utama (Excel)", calc: "Kalkulator (Pilih Tipe Manual)", breakdown: "Rincian" },
      labels: {
        sewa: "Sewa (warung) / bulan",
        tenaga: "Tenaga kerja sendiri (kalkulasi) / bulan",
        listrik: "Listrik & air / bulan",
        internet: "Internet / QRIS / bulan",
        transport: "Transport / bulan",
        lain: "Lain-lain / kehilangan / bulan",

        penjualan: "Penjualan (unit/bulan, total)",
        faktorDus: "Porsi biaya tetap untuk Dus (faktor)",
        tetapGalon: "Biaya tetap per Galon (IDR/penjualan)",
        varMinuman: "Biaya variabel minuman (IDR)",
        susutMinuman: "Susut minuman (%)",
        susutDus: "Susut Dus (%)",
        susutBuah: "Susut buah/sayur (%)",
        susutInstant: "Susut makanan instan (%)",
        cuciGalon: "Cuci / susut Galon (IDR)",
        antarGalon: "Biaya antar Galon (IDR)",
        round: "Rounding (IDR) 0 / 500 / 1000",

        type: "Tipe produk",
        ek: "Harga beli (EK) IDR"
      },
      kpis: {
        totalFixed: "Total biaya tetap / bulan",
        fixedPerUnit: "Biaya tetap per unit (otomatis)",
        fixedPerDus: "Biaya tetap per transaksi Dus (otomatis)"
      },
      types: {
        minuman: "Minuman (ecer)",
        dus: "Dus / Karton (transaksi Dus)",
        buah: "Buah / Sayur",
        instant: "Makanan instan (Tryfood/Indomie)",
        galon: "Galon"
      },
      calcBtn: "Hitung",
      enterEK: "Mohon isi EK."
    }
  };

  // ---------- Defaults (based on your sheet screenshot) ----------
  const DEFAULT = {
    lang: "id",
    currency: "IDR",
    lokasi: "Cibinong / Bogor",
    asumsi: {
      penjualan_unit_bulan: 2500,
      faktor_dus: 0.35,
      biaya_tetap_galon: 900,
      biaya_variabel_minuman: 100,
      susut_minuman_pct: 2.0,
      susut_dus_pct: 1.0,
      susut_buah_pct: 15.0,
      susut_instant_pct: 2.0,      // NEW
      cuci_susut_galon: 300,
      biaya_antar_galon: 2000,
      round_idr: 500
    },
    fixed: {
      sewa_warung: 1500000,
      tenaga_kerja_sendiri: 1500000,
      listrik_air: 300000,
      internet_qris: 150000,
      transport: 400000,
      lain_lain_kehilangan: 150000
    }
  };

  let state = load();
  let tab = "fix";

  const tabsEl = document.getElementById("tabs");
  const viewEl = document.getElementById("view");
  const langSel = document.getElementById("langSel");

  function t(){ return I18N[state.lang] || I18N.en; }

  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return structuredClone(DEFAULT);
      const obj = JSON.parse(raw);
      const merged = structuredClone(DEFAULT);
      merged.lang = obj.lang || merged.lang;
      merged.currency = obj.currency || merged.currency;
      merged.lokasi = obj.lokasi || merged.lokasi;
      merged.asumsi = { ...merged.asumsi, ...(obj.asumsi || {}) };
      merged.fixed  = { ...merged.fixed,  ...(obj.fixed  || {}) };
      return merged;
    } catch {
      return structuredClone(DEFAULT);
    }
  }

  function save(showToast=true){
    localStorage.setItem(KEY, JSON.stringify(state, null, 2));
    if (showToast) toast(t().saved);
  }

  function toast(msg){
    const title = document.getElementById("title");
    const old = title.textContent;
    title.textContent = msg;
    setTimeout(()=>title.textContent=old, 900);
  }

  // IDR formatting (thousand dot)
  function fmtIDR(n){
    const x = Math.round(Number(n) || 0);
    return x.toLocaleString("id-ID"); // uses dot thousands
  }
  function digitsOnly(s){ return String(s||"").replace(/[^\d]/g,""); }
  function num(v, fallback=0){
    const x = Number(String(v).replace(",", "."));
    return Number.isFinite(x) ? x : fallback;
  }

  function sumFixed(){
    return Object.values(state.fixed).reduce((a,b)=>a + (Number(b)||0), 0);
  }
  function fixedPerUnit(){
    const units = Math.max(1, Math.floor(Number(state.asumsi.penjualan_unit_bulan)||1));
    return sumFixed()/units;
  }
  function fixedPerDusTx(){
    return fixedPerUnit() * (Number(state.asumsi.faktor_dus)||0);
  }
  function roundIDR(x){
    const r = Math.max(0, Math.floor(Number(state.asumsi.round_idr)||0));
    if (!r) return x;
    return Math.ceil(x/r)*r;
  }

  // ---------- Rendering ----------
  function renderHeader(){
    document.getElementById("title").textContent = t().title;
    document.getElementById("subtitle").textContent = `${t().subtitle} · ${state.lokasi}`;
    document.getElementById("langLabel").textContent = t().langLabel;

    document.getElementById("exportBtn").textContent = t().buttons.export;
    document.getElementById("importBtn").textContent = t().buttons.import;
    document.getElementById("saveBtn").textContent = t().buttons.save;

    langSel.value = state.lang;
  }

  function renderTabs(){
    tabsEl.innerHTML = "";
    const defs = [
      {id:"fix", label: t().tabs.fix},
      {id:"asumsi", label: t().tabs.asumsi},
      {id:"calc", label: t().tabs.calc}
    ];
    defs.forEach(d=>{
      const b = document.createElement("button");
      b.className = "tab" + (tab===d.id ? " active" : "");
      b.textContent = d.label;
      b.onclick = ()=>{ tab=d.id; render(); };
      tabsEl.appendChild(b);
    });
  }

  function card(title, subtitle=""){
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `<b>${title}</b>${subtitle?`<div class="muted" style="margin-top:6px">${subtitle}</div>`:""}`;
    return d;
  }

  function kpiPair(leftLabel, leftValue, rightLabel, rightValue){
    const k = document.createElement("div");
    k.className = "kpi";
    k.innerHTML = `
      <div class="box"><div class="muted">${leftLabel}</div><div class="big">${leftValue}</div></div>
      <div class="box"><div class="muted">${rightLabel}</div><div class="big">${rightValue}</div></div>
    `;
    return k;
  }

  // --- Input builders (NO rerender on keystroke; format on blur)
  function rowIDR(label, getValue, setValue){
    const row = document.createElement("div");
    row.className = "row";

    const lab = document.createElement("label");
    lab.textContent = label;

    const inp = document.createElement("input");
    inp.type = "text";
    inp.inputMode = "numeric";
    inp.pattern = "[0-9]*";
    inp.value = fmtIDR(getValue());

    // focus: show raw digits + select (desktop + mobile)
    inp.addEventListener("focus", ()=>{
      inp.value = digitsOnly(inp.value);
      inp.select();
    });
    inp.addEventListener("click", ()=> inp.select());
    inp.addEventListener("pointerdown", ()=> setTimeout(()=>{ try{inp.select();}catch{} },0));

    // input: keep only digits, allow 0 and multi-digits
    inp.addEventListener("input", ()=>{
      const cleaned = digitsOnly(inp.value);
      if (cleaned !== inp.value) inp.value = cleaned;
      // do NOT re-render here
    });

    // blur: store numeric + format with thousand dots
    inp.addEventListener("blur", ()=>{
      const n = Number(digitsOnly(inp.value) || "0");
      setValue(n);
      inp.value = fmtIDR(n);
      // update KPIs live without full rerender? simplest: rerender current tab
      render(false);
    });

    row.appendChild(lab);
    row.appendChild(inp);
    return row;
  }

  function rowPCT(label, getValue, setValue){
    const row = document.createElement("div");
    row.className = "row";

    const lab = document.createElement("label");
    lab.textContent = label;

    const inp = document.createElement("input");
    inp.type = "number";
    inp.inputMode = "decimal";
    inp.step = "0.1";
    inp.min = "0";
    inp.value = String(getValue());

    inp.addEventListener("focus", ()=> inp.select());
    inp.addEventListener("click", ()=> inp.select());
    inp.addEventListener("pointerdown", ()=> setTimeout(()=>{ try{inp.select();}catch{} },0));

    // on input: do not rerender
    inp.addEventListener("input", ()=>{});

    inp.addEventListener("blur", ()=>{
      const v = Math.max(0, num(inp.value, 0));
      setValue(v);
      inp.value = String(v);
      render(false);
    });

    row.appendChild(lab);
    row.appendChild(inp);
    return row;
  }

  function renderFix(){
    const c = card(t().cards.fixed);

    c.appendChild(rowIDR(t().labels.sewa, ()=>state.fixed.sewa_warung, v=>state.fixed.sewa_warung=v));
    c.appendChild(rowIDR(t().labels.tenaga, ()=>state.fixed.tenaga_kerja_sendiri, v=>state.fixed.tenaga_kerja_sendiri=v));
    c.appendChild(rowIDR(t().labels.listrik, ()=>state.fixed.listrik_air, v=>state.fixed.listrik_air=v));
    c.appendChild(rowIDR(t().labels.internet, ()=>state.fixed.internet_qris, v=>state.fixed.internet_qris=v));
    c.appendChild(rowIDR(t().labels.transport, ()=>state.fixed.transport, v=>state.fixed.transport=v));
    c.appendChild(rowIDR(t().labels.lain, ()=>state.fixed.lain_lain_kehilangan, v=>state.fixed.lain_lain_kehilangan=v));

    c.appendChild(kpiPair(
      t().kpis.totalFixed, `${fmtIDR(sumFixed())} ${state.currency}`,
      t().kpis.fixedPerUnit, `${fmtIDR(fixedPerUnit())} ${state.currency}`
    ));

    viewEl.appendChild(c);
  }

  function renderAsumsi(){
    const c = card(t().cards.asumsi);

    c.appendChild(rowIDR(t().labels.penjualan, ()=>state.asumsi.penjualan_unit_bulan, v=>state.asumsi.penjualan_unit_bulan=Math.max(1, v)));
    // faktor dus is decimal (not percent in your sheet; it's a factor like 0.35)
    c.appendChild(rowPCT(t().labels.faktorDus, ()=>state.asumsi.faktor_dus, v=>state.asumsi.faktor_dus=v));

    c.appendChild(rowIDR(t().labels.tetapGalon, ()=>state.asumsi.biaya_tetap_galon, v=>state.asumsi.biaya_tetap_galon=v));
    c.appendChild(rowIDR(t().labels.varMinuman, ()=>state.asumsi.biaya_variabel_minuman, v=>state.asumsi.biaya_variabel_minuman=v));

    c.appendChild(rowPCT(t().labels.susutMinuman, ()=>state.asumsi.susut_minuman_pct, v=>state.asumsi.susut_minuman_pct=v));
    c.appendChild(rowPCT(t().labels.susutDus, ()=>state.asumsi.susut_dus_pct, v=>state.asumsi.susut_dus_pct=v));
    c.appendChild(rowPCT(t().labels.susutBuah, ()=>state.asumsi.susut_buah_pct, v=>state.asumsi.susut_buah_pct=v));
    c.appendChild(rowPCT(t().labels.susutInstant, ()=>state.asumsi.susut_instant_pct, v=>state.asumsi.susut_instant_pct=v)); // NEW

    c.appendChild(rowIDR(t().labels.cuciGalon, ()=>state.asumsi.cuci_susut_galon, v=>state.asumsi.cuci_susut_galon=v));
    c.appendChild(rowIDR(t().labels.antarGalon, ()=>state.asumsi.biaya_antar_galon, v=>state.asumsi.biaya_antar_galon=v));

    c.appendChild(rowIDR(t().labels.round, ()=>state.asumsi.round_idr, v=>state.asumsi.round_idr=v));

    c.appendChild(kpiPair(
      t().kpis.fixedPerUnit, `${fmtIDR(fixedPerUnit())} ${state.currency}`,
      t().kpis.fixedPerDus, `${fmtIDR(fixedPerDusTx())} ${state.currency}`
    ));

    viewEl.appendChild(c);
  }

  function renderCalc(){
    const c = card(t().cards.calc);

    const typeRow = document.createElement("div");
    typeRow.className = "row";
    const typeLabel = document.createElement("label");
    typeLabel.textContent = t().labels.type;

    const typeSel = document.createElement("select");
    typeSel.innerHTML = `
      <option value="minuman">${t().types.minuman}</option>
      <option value="dus">${t().types.dus}</option>
      <option value="buah">${t().types.buah}</option>
      <option value="instant">${t().types.instant}</option>
      <option value="galon">${t().types.galon}</option>
    `;
    typeRow.appendChild(typeLabel);
    typeRow.appendChild(typeSel);

    const ekRow = document.createElement("div");
    ekRow.className = "row";
    const ekLabel = document.createElement("label");
    ekLabel.textContent = t().labels.ek;

    const ekInp = document.createElement("input");
    ekInp.type = "text";
    ekInp.inputMode = "numeric";
    ekInp.pattern = "[0-9]*";
    ekInp.value = "";
    ekInp.placeholder = "0";

    ekInp.addEventListener("focus", ()=>{
      ekInp.value = digitsOnly(ekInp.value);
      ekInp.select();
    });
    ekInp.addEventListener("input", ()=>{
      const cleaned = digitsOnly(ekInp.value);
      if (cleaned !== ekInp.value) ekInp.value = cleaned;
    });
    ekInp.addEventListener("blur", ()=>{
      const n = Number(digitsOnly(ekInp.value)||"0");
      ekInp.value = n ? fmtIDR(n) : "";
    });

    ekRow.appendChild(ekLabel);
    ekRow.appendChild(ekInp);

    const btn = document.createElement("button");
    btn.className = "primary";
    btn.textContent = t().calcBtn;

    const out = document.createElement("div");
    out.className = "card";
    out.innerHTML = `<div class="muted">${t().cards.breakdown}</div>`;

    btn.onclick = () => {
      const EK = Number(digitsOnly(ekInp.value)||"0");
      if (!EK) { out.innerHTML = `<div class="muted">${t().enterEK}</div>`; return; }

      const type = typeSel.value;

      let susutPct = 0;
      let fixed = 0;
      let extra = 0;

      if (type === "minuman") {
        susutPct = (Number(state.asumsi.susut_minuman_pct)||0) / 100;
        fixed = fixedPerUnit();
        extra = Number(state.asumsi.biaya_variabel_minuman)||0;
      } else if (type === "dus") {
        susutPct = (Number(state.asumsi.susut_dus_pct)||0) / 100;
        fixed = fixedPerDusTx();
      } else if (type === "buah") {
        susutPct = (Number(state.asumsi.susut_buah_pct)||0) / 100;
        fixed = fixedPerUnit();
      } else if (type === "instant") {
        susutPct = (Number(state.asumsi.susut_instant_pct)||0) / 100;
        fixed = fixedPerUnit();
      } else if (type === "galon") {
        susutPct = 0;
        fixed = Number(state.asumsi.biaya_tetap_galon)||0;
        extra = (Number(state.asumsi.cuci_susut_galon)||0) + (Number(state.asumsi.biaya_antar_galon)||0);
      }

      const susut = EK * susutPct;
      const minPrice = EK + susut + fixed + extra;
      const suggested = roundIDR(minPrice);

      out.innerHTML = `
        <div class="kpi">
          <div class="box">
            <div class="muted">${state.lang==="id" ? "Harga minimum" : "Minimum price"}</div>
            <div class="big">${fmtIDR(minPrice)} <span class="muted">${state.currency}</span></div>
          </div>
          <div class="box">
            <div class="muted">${state.lang==="id" ? "Saran (dibulatkan)" : "Suggested (rounded)"}</div>
            <div class="big">${fmtIDR(suggested)} <span class="muted">${state.currency}</span></div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="muted">${t().cards.breakdown}</div>
        <div>EK: <b>${fmtIDR(EK)}</b></div>
        <div>Susut: <b>${fmtIDR(susut)}</b> (${(susutPct*100).toFixed(2)}%)</div>
        <div>Fixed: <b>${fmtIDR(fixed)}</b></div>
        <div>Extra: <b>${fmtIDR(extra)}</b></div>
      `;
    };

    c.appendChild(typeRow);
    c.appendChild(ekRow);
    c.appendChild(btn);

    viewEl.appendChild(c);
    viewEl.appendChild(out);
  }

  function render(withHeader=true){
    if (withHeader) renderHeader();
    renderTabs();
    viewEl.innerHTML = "";
    if (tab==="fix") renderFix();
    if (tab==="asumsi") renderAsumsi();
    if (tab==="calc") renderCalc();
  }

  // ---------- buttons ----------
  document.getElementById("saveBtn").onclick = () => save(true);

  document.getElementById("exportBtn").onclick = async () => {
    const json = JSON.stringify(state, null, 2);
    try {
      await navigator.clipboard.writeText(json);
      toast("JSON ✅");
    } catch {
      prompt("JSON:", json);
    }
  };

  document.getElementById("importBtn").onclick = () => {
    const txt = prompt("JSON:");
    if (!txt) return;
    try {
      const obj = JSON.parse(txt);
      const merged = structuredClone(DEFAULT);
      merged.lang = obj.lang || merged.lang;
      merged.currency = obj.currency || merged.currency;
      merged.lokasi = obj.lokasi || merged.lokasi;
      merged.asumsi = { ...merged.asumsi, ...(obj.asumsi || {}) };
      merged.fixed  = { ...merged.fixed,  ...(obj.fixed  || {}) };
      state = merged;
      save(false);
      render(true);
      toast("Imported ✅");
    } catch {
      toast("Invalid JSON");
    }
  };

  // ---------- language ----------
  langSel.addEventListener("change", ()=>{
    state.lang = langSel.value;
    save(false);
    render(true);
  });

  // Init
  render(true);
})();
</script>
</body>
</html>
