<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warung Pricing</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0b1220; color:#e5e7eb; }
    header { padding:14px 16px; background:#111827; border-bottom:1px solid #1f2937; position: sticky; top:0; z-index: 5; }
    h1 { margin:0; font-size:16px; }
    .muted { color:#94a3b8; font-size:12px; }
    .topbar { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:8px; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #1f2937; background:#0f172a; }
    .pill select { border:none; background:transparent; color:#e5e7eb; padding:0; width:auto; }
    .tabs { display:flex; gap:8px; padding:10px 16px; border-bottom:1px solid #1f2937; overflow:auto; position: sticky; top:74px; background:#0b1220; z-index: 4; }
    .tab { padding:8px 12px; border-radius:999px; border:1px solid #1f2937; background:#0f172a; color:#e5e7eb; cursor:pointer; white-space: nowrap; }
    .tab.active { background:#2563eb; border-color:#2563eb; }
    main { padding:16px 16px 90px; max-width:820px; margin:auto; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:12px; margin-bottom:12px; }
    .row { display:grid; grid-template-columns:1fr 220px; gap:10px; align-items:center; margin:10px 0; }
    label { font-size:13px; color:#cbd5e1; }
    input, select, button {
      width:100%; padding:10px; border-radius:10px;
      border:1px solid #334155; background:#0b1220; color:#e5e7eb;
      font-size:14px; box-sizing: border-box;
    }
    button { background:#1f2937; cursor:pointer; }
    button.primary { background:#2563eb; border-color:#2563eb; }
    .kpi { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px; }
    .kpi .box { background:#0b1220; border:1px solid #1f2937; padding:10px; border-radius:12px; }
    .big { font-size:18px; font-weight:700; }
    .footer { position:fixed; bottom:0; left:0; right:0; background:#111827; border-top:1px solid #1f2937; padding:10px 16px; display:flex; gap:10px; z-index: 6; }
    .footer button { flex:1; }
    .hr { height:1px; background:#1f2937; margin:12px 0; }
    .hint { margin-top:8px; }
  </style>
</head>

<body>
<header>
  <h1 id="title">Warung Pricing</h1>
  <div class="topbar">
    <div class="muted" id="subtitle"></div>
    <div class="pill">
      <span class="muted" id="langLabel">Language</span>
      <select id="langSel" aria-label="Language">
        <option value="id">Bahasa</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>
</header>

<div class="tabs" id="tabs"></div>
<main id="view"></main>

<div class="footer">
  <button id="exportBtn">JSON Export</button>
  <button id="importBtn">JSON Import</button>
  <button class="primary" id="saveBtn">Save</button>
</div>

<script>
(() => {
  const KEY = "warung_pricing_excel_model_v2";

  // --- i18n
  const I18N = {
    en: {
      title: "Warung Pricing",
      subtitle: "Excel-based model · manual product type · works offline",
      langLabel: "Language",
      tabs: {
        fix: "1) Fixed Costs",
        asumsi: "2) Assumptions",
        calc: "3) Calculator"
      },
      buttons: { export: "JSON Export", import: "JSON Import", save: "Save" },
      saved: "Saved ✅",
      cards: {
        fixed: "Monthly Fixed Costs",
        asumsi: "Main Assumptions (Excel)",
        calc: "Calculator (Manual Type)",
        result: "Result",
        breakdown: "Breakdown"
      },
      labels: {
        sewa: "Rent (warung) / month",
        tenaga: "Own labor (calculation) / month",
        listrik: "Electricity & water / month",
        internet: "Internet / QRIS / month",
        transport: "Transport / month",
        lain: "Other / losses / month",

        penjualan: "Sales (units/month total)",
        faktorDus: "Fixed-cost share for Dus (factor)",
        tetapGalon: "Fixed cost per Galon (IDR/sale)",
        varMinuman: "Variable beverage cost (IDR)",
        susutMinuman: "Shrinkage beverage (%)",
        susutDus: "Shrinkage Dus (%)",
        susutBuah: "Shrinkage fruit/veg (%)",
        cuciGalon: "Wash/shrink Galon (IDR)",
        antarGalon: "Delivery Galon (IDR)",
        round: "Rounding (IDR) 0 / 500 / 1000",

        type: "Product type",
        ek: "Purchase price (EK) IDR"
      },
      kpis: {
        totalFixed: "Total fixed costs / month",
        fixedPerUnit: "Fixed cost per unit (auto)",
        fixedPerDus: "Fixed cost per Dus transaction (auto)"
      },
      types: {
        minuman: "Beverage (single sale)",
        dus: "Dus / Carton (Dus transaction)",
        buah: "Fruit / Vegetables",
        galon: "Galon"
      },
      calcHint: {
        minuman: (sPct, fix, extra) => `Shrinkage: ${sPct}% · Fixed: ${fix} · + Variable beverage: ${extra}`,
        dus: (sPct, fixDus) => `Shrinkage: ${sPct}% · Fixed per Dus transaction: ${fixDus}`,
        buah: (sPct, fix) => `Shrinkage: ${sPct}% · Fixed: ${fix}`,
        galon: (fix, cuci, antar) => `Fixed Galon: ${fix} · + Wash: ${cuci} · + Delivery: ${antar}`
      },
      jsonPromptExport: "Copy JSON:",
      jsonPromptImport: "Paste JSON (overwrites settings):",
      enterEK: "Please enter EK."
    },

    id: {
      title: "Kalkulator Harga Warung",
      subtitle: "Model Excel · pilih tipe manual · bisa offline",
      langLabel: "Bahasa",
      tabs: {
        fix: "1) Biaya Tetap",
        asumsi: "2) Asumsi",
        calc: "3) Kalkulator"
      },
      buttons: { export: "Export JSON", import: "Import JSON", save: "Simpan" },
      saved: "Tersimpan ✅",
      cards: {
        fixed: "Biaya Tetap (bulanan)",
        asumsi: "Asumsi Utama (Excel)",
        calc: "Kalkulator (Pilih Tipe Manual)",
        result: "Hasil",
        breakdown: "Rincian"
      },
      labels: {
        sewa: "Sewa (warung) / bulan",
        tenaga: "Tenaga kerja sendiri (kalkulasi) / bulan",
        listrik: "Listrik & air / bulan",
        internet: "Internet / QRIS / bulan",
        transport: "Transport / bulan",
        lain: "Lain-lain / kehilangan / bulan",

        penjualan: "Penjualan (unit/bulan, total)",
        faktorDus: "Porsi biaya tetap untuk Dus (faktor)",
        tetapGalon: "Biaya tetap per Galon (IDR/penjualan)",
        varMinuman: "Biaya variabel minuman (IDR)",
        susutMinuman: "Susut minuman (%)",
        susutDus: "Susut Dus (%)",
        susutBuah: "Susut buah/sayur (%)",
        cuciGalon: "Cuci / susut Galon (IDR)",
        antarGalon: "Biaya antar Galon (IDR)",
        round: "Rounding (IDR) 0 / 500 / 1000",

        type: "Tipe produk",
        ek: "Harga beli (EK) IDR"
      },
      kpis: {
        totalFixed: "Total biaya tetap / bulan",
        fixedPerUnit: "Biaya tetap per unit (otomatis)",
        fixedPerDus: "Biaya tetap per transaksi Dus (otomatis)"
      },
      types: {
        minuman: "Minuman (ecer)",
        dus: "Dus / Karton (transaksi Dus)",
        buah: "Buah / Sayur",
        galon: "Galon"
      },
      calcHint: {
        minuman: (sPct, fix, extra) => `Susut: ${sPct}% · Biaya tetap: ${fix} · + Biaya variabel minuman: ${extra}`,
        dus: (sPct, fixDus) => `Susut: ${sPct}% · Biaya tetap per transaksi Dus: ${fixDus}`,
        buah: (sPct, fix) => `Susut: ${sPct}% · Biaya tetap: ${fix}`,
        galon: (fix, cuci, antar) => `Biaya tetap Galon: ${fix} · + Cuci: ${cuci} · + Antar: ${antar}`
      },
      jsonPromptExport: "Salin JSON:",
      jsonPromptImport: "Tempel JSON (menimpa setting):",
      enterEK: "Mohon isi EK."
    }
  };

  // --- Defaults from your sheet screenshot
  const DEFAULT = {
    lang: "id",
    currency: "IDR",
    lokasi: "Cibinong / Bogor",
    asumsi: {
      penjualan_unit_bulan: 2500,
      faktor_dus: 0.35,
      biaya_tetap_galon: 900,
      biaya_variabel_minuman: 100,
      susut_minuman_pct: 2.0,
      susut_dus_pct: 1.0,
      susut_buah_pct: 15.0,
      cuci_susut_galon: 300,
      biaya_antar_galon: 2000,
      round_idr: 500
    },
    fixed: {
      sewa_warung: 1500000,
      tenaga_kerja_sendiri: 1500000,
      listrik_air: 300000,
      internet_qris: 150000,
      transport: 400000,
      lain_lain_kehilangan: 150000
    }
  };

  // --- State
  let state = load();
  let tab = "fix";

  const TABS = [
    {id:"fix", labelKey:"fix"},
    {id:"asumsi", labelKey:"asumsi"},
    {id:"calc", labelKey:"calc"}
  ];

  // --- Helpers
  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return structuredClone(DEFAULT);
      const obj = JSON.parse(raw);

      // Merge (keep future-proof)
      const merged = structuredClone(DEFAULT);
      merged.lang = obj.lang || merged.lang;
      merged.currency = obj.currency || merged.currency;
      merged.lokasi = obj.lokasi || merged.lokasi;
      merged.asumsi = { ...merged.asumsi, ...(obj.asumsi || {}) };
      merged.fixed  = { ...merged.fixed,  ...(obj.fixed  || {}) };
      return merged;
    } catch {
      return structuredClone(DEFAULT);
    }
  }

  function save(showToast=true) {
    localStorage.setItem(KEY, JSON.stringify(state, null, 2));
    if (showToast) toast(t().saved);
  }

  function t() {
    return I18N[state.lang] || I18N.en;
  }

  function moneyIDR(x) {
    const n = Math.round(x);
    return n.toLocaleString("id-ID");
  }

  function numStrictDigits(str) {
    // Keep only digits (for IDR)
    return String(str || "").replace(/[^\d]/g, "");
  }

  function numLoose(v, fallback=0) {
    const x = Number(String(v).replace(",", "."));
    return Number.isFinite(x) ? x : fallback;
  }

  function sumFixed() {
    return Object.values(state.fixed).reduce((a,b)=>a + numLoose(b,0), 0);
  }

  function fixedPerUnit() {
    const units = Math.max(1, Math.floor(numLoose(state.asumsi.penjualan_unit_bulan, 1)));
    return sumFixed() / units;
  }

  function fixedPerDusTx() {
    return fixedPerUnit() * numLoose(state.asumsi.faktor_dus, 0);
  }

  function roundIDR(x) {
    const r = Math.max(0, Math.floor(numLoose(state.asumsi.round_idr, 0)));
    if (!r) return x;
    return Math.ceil(x / r) * r;
  }

  function toast(msg) {
    const title = document.getElementById("title");
    const old = title.textContent;
    title.textContent = msg;
    setTimeout(()=> title.textContent = old, 900);
  }

  // --- Robust "overwrite on desktop + mobile"
  function enableAutoSelect(input) {
    // Focus select (works on mobile)
    input.addEventListener("focus", () => {
      try { input.select(); } catch {}
      // Some desktop browsers need a micro-delay
      setTimeout(() => { try { input.select(); } catch {} }, 0);
    });

    // Click select (desktop often sets caret otherwise)
    input.addEventListener("click", () => {
      try { input.select(); } catch {}
    });

    // Pointer down: if already focused, still select
    input.addEventListener("pointerdown", () => {
      setTimeout(() => { try { input.select(); } catch {} }, 0);
    });
  }

  // --- UI Render
  const tabsEl = document.getElementById("tabs");
  const viewEl = document.getElementById("view");
  const langSel = document.getElementById("langSel");

  function renderHeader() {
    document.getElementById("title").textContent = t().title;
    document.getElementById("subtitle").textContent = `${t().subtitle} · ${state.lokasi}`;
    document.getElementById("langLabel").textContent = t().langLabel;

    document.getElementById("exportBtn").textContent = t().buttons.export;
    document.getElementById("importBtn").textContent = t().buttons.import;
    document.getElementById("saveBtn").textContent = t().buttons.save;

    langSel.value = state.lang;
  }

  function renderTabs() {
    tabsEl.innerHTML = "";
    TABS.forEach(x => {
      const b = document.createElement("button");
      b.className = "tab" + (tab === x.id ? " active" : "");
      b.textContent = t().tabs[x.labelKey];
      b.onclick = () => { tab = x.id; render(); };
      tabsEl.appendChild(b);
    });
  }

  function card(title, html="") {
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `<b>${title}</b>${html ? `<div class="hint muted">${html}</div>` : ""}`;
    return d;
  }

  function kpiPair(leftLabel, leftValue, rightLabel, rightValue) {
    const k = document.createElement("div");
    k.className = "kpi";
    k.innerHTML = `
      <div class="box">
        <div class="muted">${leftLabel}</div>
        <div class="big">${leftValue}</div>
      </div>
      <div class="box">
        <div class="muted">${rightLabel}</div>
        <div class="big">${rightValue}</div>
      </div>
    `;
    return k;
  }

  // Input row: IDR (digits only) or PCT (decimal)
  function rowInput({label, value, kind="idr", onChange}) {
    const row = document.createElement("div");
    row.className = "row";

    const isPct = kind === "pct";
    const input = document.createElement("input");

    // Type + keyboard
    if (isPct) {
      input.type = "number";
      input.inputMode = "decimal";
      input.step = "0.1";
      input.min = "0";
      input.value = String(numLoose(value, 0));
    } else {
      input.type = "text";
      input.inputMode = "numeric";
      input.pattern = "[0-9]*";
      input.value = String(Math.floor(numLoose(value, 0)));
    }

    enableAutoSelect(input);

    // Behavior
    input.addEventListener("input", () => {
      if (isPct) {
        onChange(Math.max(0, numLoose(input.value, 0)));
      } else {
        const cleaned = numStrictDigits(input.value);
        if (cleaned !== input.value) input.value = cleaned;
        onChange(Math.max(0, Math.floor(numLoose(cleaned, 0))));
      }
      // live update without forcing save
      render(false);
    });

    const labelEl = document.createElement("label");
    labelEl.textContent = label;

    const right = document.createElement("div");
    right.appendChild(input);

    // Show formatted IDR below field (nice)
    if (!isPct) {
      const fmt = document.createElement("div");
      fmt.className = "muted";
      fmt.style.marginTop = "6px";
      fmt.textContent = `${moneyIDR(numLoose(value,0))} ${state.currency}`;
      right.appendChild(fmt);
    }

    row.appendChild(labelEl);
    row.appendChild(right);
    return row;
  }

  function renderFix() {
    const c = card(t().cards.fixed);

    c.appendChild(rowInput({ label: t().labels.sewa, value: state.fixed.sewa_warung,
      onChange: v => state.fixed.sewa_warung = v
    }));
    c.appendChild(rowInput({ label: t().labels.tenaga, value: state.fixed.tenaga_kerja_sendiri,
      onChange: v => state.fixed.tenaga_kerja_sendiri = v
    }));
    c.appendChild(rowInput({ label: t().labels.listrik, value: state.fixed.listrik_air,
      onChange: v => state.fixed.listrik_air = v
    }));
    c.appendChild(rowInput({ label: t().labels.internet, value: state.fixed.internet_qris,
      onChange: v => state.fixed.internet_qris = v
    }));
    c.appendChild(rowInput({ label: t().labels.transport, value: state.fixed.transport,
      onChange: v => state.fixed.transport = v
    }));
    c.appendChild(rowInput({ label: t().labels.lain, value: state.fixed.lain_lain_kehilangan,
      onChange: v => state.fixed.lain_lain_kehilangan = v
    }));

    c.appendChild(kpiPair(
      t().kpis.totalFixed,
      `${moneyIDR(sumFixed())} ${state.currency}`,
      t().kpis.fixedPerUnit,
      `${moneyIDR(fixedPerUnit())} ${state.currency}`
    ));

    viewEl.appendChild(c);
  }

  function renderAsumsi() {
    const c = card(t().cards.asumsi);

    c.appendChild(rowInput({ label: t().labels.penjualan, value: state.asumsi.penjualan_unit_bulan,
      onChange: v => state.asumsi.penjualan_unit_bulan = Math.max(1, Math.floor(v))
    }));
    c.appendChild(rowInput({ label: t().labels.faktorDus, value: state.asumsi.faktor_dus, kind: "pct",
      onChange: v => state.asumsi.faktor_dus = v
    }));
    c.appendChild(rowInput({ label: t().labels.tetapGalon, value: state.asumsi.biaya_tetap_galon,
      onChange: v => state.asumsi.biaya_tetap_galon = v
    }));
    c.appendChild(rowInput({ label: t().labels.varMinuman, value: state.asumsi.biaya_variabel_minuman,
      onChange: v => state.asumsi.biaya_variabel_minuman = v
    }));

    c.appendChild(rowInput({ label: t().labels.susutMinuman, value: state.asumsi.susut_minuman_pct, kind: "pct",
      onChange: v => state.asumsi.susut_minuman_pct = v
    }));
    c.appendChild(rowInput({ label: t().labels.susutDus, value: state.asumsi.susut_dus_pct, kind: "pct",
      onChange: v => state.asumsi.susut_dus_pct = v
    }));
    c.appendChild(rowInput({ label: t().labels.susutBuah, value: state.asumsi.susut_buah_pct, kind: "pct",
      onChange: v => state.asumsi.susut_buah_pct = v
    }));

    c.appendChild(rowInput({ label: t().labels.cuciGalon, value: state.asumsi.cuci_susut_galon,
      onChange: v => state.asumsi.cuci_susut_galon = v
    }));
    c.appendChild(rowInput({ label: t().labels.antarGalon, value: state.asumsi.biaya_antar_galon,
      onChange: v => state.asumsi.biaya_antar_galon = v
    }));
    c.appendChild(rowInput({ label: t().labels.round, value: state.asumsi.round_idr,
      onChange: v => state.asumsi.round_idr = v
    }));

    c.appendChild(kpiPair(
      t().kpis.fixedPerUnit,
      `${moneyIDR(fixedPerUnit())} ${state.currency}`,
      t().kpis.fixedPerDus,
      `${moneyIDR(fixedPerDusTx())} ${state.currency}`
    ));

    viewEl.appendChild(c);
  }

  function renderCalc() {
    const c = card(t().cards.calc, state.lang === "id"
      ? "Isi EK → pilih tipe → hitung minimum price."
      : "Enter EK → choose type → calculate minimum price."
    );

    const typeRow = document.createElement("div");
    typeRow.className = "row";
    const typeLabel = document.createElement("label");
    typeLabel.textContent = t().labels.type;

    const typeSel = document.createElement("select");
    typeSel.innerHTML = `
      <option value="minuman">${t().types.minuman}</option>
      <option value="dus">${t().types.dus}</option>
      <option value="buah">${t().types.buah}</option>
      <option value="galon">${t().types.galon}</option>
    `;

    typeRow.appendChild(typeLabel);
    typeRow.appendChild(typeSel);

    // EK input
    const ekRow = document.createElement("div");
    ekRow.className = "row";
    const ekLabel = document.createElement("label");
    ekLabel.textContent = t().labels.ek;

    const ekWrap = document.createElement("div");
    const ekInp = document.createElement("input");
    ekInp.type = "text";
    ekInp.inputMode = "numeric";
    ekInp.pattern = "[0-9]*";
    ekInp.placeholder = "0";
    enableAutoSelect(ekInp);
    ekInp.addEventListener("input", () => {
      const cleaned = numStrictDigits(ekInp.value);
      if (cleaned !== ekInp.value) ekInp.value = cleaned;
    });

    ekWrap.appendChild(ekInp);
    const ekFmt = document.createElement("div");
    ekFmt.className = "muted";
    ekFmt.style.marginTop = "6px";
    ekFmt.textContent = `0 ${state.currency}`;
    ekWrap.appendChild(ekFmt);

    ekRow.appendChild(ekLabel);
    ekRow.appendChild(ekWrap);

    // Hint
    const hint = document.createElement("div");
    hint.className = "card";
    hint.innerHTML = `<b>${t().cards.breakdown}</b><div class="muted" id="hintText" style="margin-top:8px"></div>`;

    // Button
    const btn = document.createElement("button");
    btn.className = "primary";
    btn.textContent = (state.lang === "id") ? "Hitung" : "Calculate";
    btn.style.marginTop = "10px";

    // Output
    const out = document.createElement("div");
    out.className = "card";
    out.innerHTML = `<div class="muted">${t().cards.result}</div>`;

    function updateHint() {
      const type = typeSel.value;
      const h = hint.querySelector("#hintText");

      if (type === "minuman") {
        h.textContent = t().calcHint.minuman(
          state.asumsi.susut_minuman_pct,
          `${moneyIDR(fixedPerUnit())} ${state.currency}`,
          `${moneyIDR(state.asumsi.biaya_variabel_minuman)} ${state.currency}`
        );
      } else if (type === "dus") {
        h.textContent = t().calcHint.dus(
          state.asumsi.susut_dus_pct,
          `${moneyIDR(fixedPerDusTx())} ${state.currency}`
        );
      } else if (type === "buah") {
        h.textContent = t().calcHint.buah(
          state.asumsi.susut_buah_pct,
          `${moneyIDR(fixedPerUnit())} ${state.currency}`
        );
      } else {
        h.textContent = t().calcHint.galon(
          `${moneyIDR(state.asumsi.biaya_tetap_galon)} ${state.currency}`,
          `${moneyIDR(state.asumsi.cuci_susut_galon)} ${state.currency}`,
          `${moneyIDR(state.asumsi.biaya_antar_galon)} ${state.currency}`
        );
      }
    }

    typeSel.addEventListener("change", () => {
      updateHint();
    });

    // live EK formatting
    ekInp.addEventListener("input", () => {
      ekFmt.textContent = `${moneyIDR(numLoose(ekInp.value,0))} ${state.currency}`;
    });

    btn.onclick = () => {
      const EK = Math.max(0, Math.floor(numLoose(ekInp.value, 0)));
      if (!EK) {
        out.innerHTML = `<div class="muted">${t().enterEK}</div>`;
        return;
      }

      const type = typeSel.value;

      let susutPct = 0;
      let fixed = 0;
      let extra = 0;

      if (type === "minuman") {
        susutPct = numLoose(state.asumsi.susut_minuman_pct, 0) / 100;
        fixed = fixedPerUnit();
        extra = numLoose(state.asumsi.biaya_variabel_minuman, 0);
      }
      if (type === "dus") {
        susutPct = numLoose(state.asumsi.susut_dus_pct, 0) / 100;
        fixed = fixedPerDusTx();
      }
      if (type === "buah") {
        susutPct = numLoose(state.asumsi.susut_buah_pct, 0) / 100;
        fixed = fixedPerUnit();
      }
      if (type === "galon") {
        susutPct = 0; // in your sheet Galon uses fixed + wash + delivery
        fixed = numLoose(state.asumsi.biaya_tetap_galon, 0);
        extra = numLoose(state.asumsi.cuci_susut_galon, 0) + numLoose(state.asumsi.biaya_antar_galon, 0);
      }

      const susut = EK * susutPct;
      const minPrice = EK + susut + fixed + extra;
      const suggested = roundIDR(minPrice);

      out.innerHTML = `
        <div class="kpi">
          <div class="box">
            <div class="muted">${(state.lang === "id") ? "Harga minimum" : "Minimum price"}</div>
            <div class="big">${moneyIDR(minPrice)} <span class="muted">${state.currency}</span></div>
          </div>
          <div class="box">
            <div class="muted">${(state.lang === "id") ? "Saran (dibulatkan)" : "Suggested (rounded)"}</div>
            <div class="big">${moneyIDR(suggested)} <span class="muted">${state.currency}</span></div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="muted">${t().cards.breakdown}</div>
        <div>EK: <b>${moneyIDR(EK)}</b></div>
        <div>Susut: <b>${moneyIDR(susut)}</b> (${(susutPct*100).toFixed(2)}%)</div>
        <div>Fixed: <b>${moneyIDR(fixed)}</b></div>
        <div>Extra: <b>${moneyIDR(extra)}</b></div>
      `;
    };

    c.appendChild(typeRow);
    c.appendChild(ekRow);
    c.appendChild(btn);

    viewEl.appendChild(c);
    viewEl.appendChild(hint);
    viewEl.appendChild(out);

    updateHint();
  }

  function render(doHeader=true) {
    if (doHeader) renderHeader();
    renderTabs();
    viewEl.innerHTML = "";

    if (tab === "fix") renderFix();
    if (tab === "asumsi") renderAsumsi();
    if (tab === "calc") renderCalc();
  }

  // --- Events: language switch
  langSel.addEventListener("change", () => {
    state.lang = langSel.value;
    save(false);
    render(true);
  });

  // --- Buttons
  document.getElementById("saveBtn").onclick = () => save(true);

  document.getElementById("exportBtn").onclick = async () => {
    const json = JSON.stringify(state, null, 2);
    try {
      await navigator.clipboard.writeText(json);
      toast("JSON ✅");
    } catch {
      prompt(t().jsonPromptExport, json);
    }
  };

  document.getElementById("importBtn").onclick = () => {
    const txt = prompt(t().jsonPromptImport);
    if (!txt) return;
    try {
      const obj = JSON.parse(txt);
      // merge into defaults for safety
      const merged = structuredClone(DEFAULT);
      merged.lang = obj.lang || merged.lang;
      merged.currency = obj.currency || merged.currency;
      merged.lokasi = obj.lokasi || merged.lokasi;
      merged.asumsi = { ...merged.asumsi, ...(obj.asumsi || {}) };
      merged.fixed  = { ...merged.fixed,  ...(obj.fixed  || {}) };
      state = merged;
      save(false);
      render(true);
      toast("Imported ✅");
    } catch {
      toast("Invalid JSON");
    }
  };

  // --- Init
  render(true);
})();
</script>
</body>
</html>
